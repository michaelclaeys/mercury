<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://unpkg.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self' http://localhost:8778 https://engine.mercurysuite.net https://mercurysuite.net https://*.supabase.co https://api.coingecko.com https://api.alternative.me https://gamma-api.polymarket.com https://clob.polymarket.com https://api.elections.kalshi.com https://*.binance.com https://*.coinbase.com wss://*.supabase.co; frame-ancestors 'none';">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta name="robots" content="noindex, nofollow">
    <title>Mercury — Admin</title>
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
/* ================================================================
   MERCURY ADMIN — Internal Bot Performance Dashboard
   Same dark terminal aesthetic as main site
   ================================================================ */
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }

:root {
    --black: #000000;
    --surface: #080808;
    --elevated: #0f0f0f;
    --border: #1a1a1a;
    --border-mid: #252525;
    --border-bright: #333333;
    --dim: #444444;
    --silver: #909090;
    --text: #b0b0b0;
    --bright: #d0d0d0;
    --white: #e8e8e8;
    --pure: #ffffff;
    --green: #00c853;
    --red: #ff1744;
    --yellow: #ffd600;
    --blue: #448aff;
    --mono: 'JetBrains Mono', 'Fira Code', 'Courier New', monospace;
}

html { font-size: 13px; }
body {
    font-family: var(--mono);
    background: var(--black);
    color: var(--text);
    line-height: 1.5;
    -webkit-font-smoothing: antialiased;
    min-height: 100vh;
}

/* ── Login ─────────────────────────────────────────── */
#login-screen {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    flex-direction: column;
    gap: 1.5rem;
}
#login-screen h1 {
    font-size: 1rem;
    color: var(--silver);
    font-weight: 400;
    letter-spacing: 0.15em;
    text-transform: uppercase;
}
#login-screen .login-box {
    display: flex;
    gap: 0.5rem;
}
#login-screen input {
    background: var(--surface);
    border: 1px solid var(--border-mid);
    color: var(--white);
    font-family: var(--mono);
    font-size: 0.85rem;
    padding: 0.6rem 1rem;
    width: 280px;
    outline: none;
}
#login-screen input:focus { border-color: var(--green); }
#login-screen input::placeholder { color: var(--dim); }
#login-screen button {
    background: var(--green);
    color: var(--black);
    border: none;
    font-family: var(--mono);
    font-size: 0.8rem;
    font-weight: 600;
    padding: 0.6rem 1.2rem;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 0.08em;
}
#login-screen button:hover { filter: brightness(1.1); }
#login-error {
    color: var(--red);
    font-size: 0.8rem;
    height: 1.2rem;
}

/* ── Dashboard ─────────────────────────────────────── */
#dashboard { display: none; }

/* Stats header */
.stats-bar {
    display: flex;
    gap: 1px;
    background: var(--border);
    border-bottom: 1px solid var(--border);
}
.stat-card {
    flex: 1;
    background: var(--surface);
    padding: 1rem 1.2rem;
    text-align: center;
}
.stat-card .label {
    font-size: 0.65rem;
    color: var(--dim);
    text-transform: uppercase;
    letter-spacing: 0.12em;
    margin-bottom: 0.3rem;
}
.stat-card .value {
    font-size: 1.4rem;
    font-weight: 600;
    color: var(--white);
}
.stat-card .value.green { color: var(--green); }

/* Toolbar */
.toolbar {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.8rem 1.2rem;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
}
.toolbar h2 {
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--bright);
    margin-right: auto;
    letter-spacing: 0.06em;
}
.toolbar select, .toolbar input {
    background: var(--elevated);
    border: 1px solid var(--border-mid);
    color: var(--text);
    font-family: var(--mono);
    font-size: 0.75rem;
    padding: 0.4rem 0.6rem;
    outline: none;
}
.toolbar select:focus, .toolbar input:focus { border-color: var(--green); }
.toolbar label {
    font-size: 0.7rem;
    color: var(--dim);
    text-transform: uppercase;
    letter-spacing: 0.08em;
}
.toolbar .filter-group {
    display: flex;
    align-items: center;
    gap: 0.4rem;
}
.toolbar button {
    background: var(--elevated);
    border: 1px solid var(--border-mid);
    color: var(--text);
    font-family: var(--mono);
    font-size: 0.75rem;
    padding: 0.4rem 0.8rem;
    cursor: pointer;
}
.toolbar button:hover { border-color: var(--green); color: var(--green); }
.toolbar button.active { border-color: var(--green); color: var(--green); }

/* Leaderboard table */
.table-wrap {
    overflow-x: auto;
}
table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.8rem;
}
thead th {
    background: var(--surface);
    padding: 0.6rem 0.8rem;
    text-align: left;
    font-weight: 500;
    color: var(--dim);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-size: 0.65rem;
    border-bottom: 1px solid var(--border-mid);
    cursor: pointer;
    white-space: nowrap;
    user-select: none;
    position: sticky;
    top: 0;
    z-index: 2;
}
thead th:hover { color: var(--green); }
thead th.sorted { color: var(--green); }
thead th .arrow { font-size: 0.6rem; margin-left: 0.3rem; }
tbody tr {
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    transition: background 0.1s;
}
tbody tr:hover { background: var(--elevated); }
tbody tr.selected { background: #0a1a0a; }
td {
    padding: 0.55rem 0.8rem;
    white-space: nowrap;
}
td.pos { color: var(--green); }
td.neg { color: var(--red); }
td.muted { color: var(--dim); }

.rank-cell {
    font-weight: 600;
    color: var(--silver);
    width: 40px;
    text-align: center;
}
.rank-cell.gold { color: #ffd700; }
.rank-cell.silver-rank { color: #c0c0c0; }
.rank-cell.bronze { color: #cd7f32; }

.status-dot {
    display: inline-block;
    width: 6px;
    height: 6px;
    border-radius: 50%;
    margin-right: 0.4rem;
    vertical-align: middle;
}
.status-dot.live { background: var(--green); box-shadow: 0 0 4px var(--green); }
.status-dot.paused { background: var(--yellow); }
.status-dot.stopped { background: var(--dim); }
.status-dot.error { background: var(--red); }

.spark-container {
    width: 80px;
    height: 24px;
}
.spark-container svg { width: 100%; height: 100%; }

.funding-flag {
    font-size: 0.65rem;
    padding: 0.15rem 0.4rem;
    background: var(--green);
    color: var(--black);
    font-weight: 600;
    letter-spacing: 0.06em;
}
.funding-flag.unflagged {
    background: transparent;
    border: 1px solid var(--border-mid);
    color: var(--dim);
    cursor: pointer;
}
.funding-flag.unflagged:hover { border-color: var(--green); color: var(--green); }

/* ── Detail Panel ──────────────────────────────────── */
#detail-panel {
    display: none;
    border-top: 2px solid var(--green);
    background: var(--surface);
}
#detail-panel.open { display: block; }

.detail-header {
    display: flex;
    align-items: center;
    padding: 1rem 1.2rem;
    border-bottom: 1px solid var(--border);
    gap: 1rem;
}
.detail-header h3 {
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--white);
}
.detail-header .meta {
    font-size: 0.75rem;
    color: var(--dim);
}
.detail-header .close-btn {
    margin-left: auto;
    background: none;
    border: 1px solid var(--border-mid);
    color: var(--silver);
    font-family: var(--mono);
    font-size: 0.75rem;
    padding: 0.3rem 0.8rem;
    cursor: pointer;
}
.detail-header .close-btn:hover { border-color: var(--red); color: var(--red); }

.detail-tabs {
    display: flex;
    border-bottom: 1px solid var(--border);
}
.detail-tabs button {
    background: none;
    border: none;
    border-bottom: 2px solid transparent;
    color: var(--dim);
    font-family: var(--mono);
    font-size: 0.75rem;
    padding: 0.7rem 1.2rem;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 0.06em;
}
.detail-tabs button:hover { color: var(--text); }
.detail-tabs button.active {
    color: var(--green);
    border-bottom-color: var(--green);
}

.detail-content {
    padding: 1.2rem;
    max-height: 600px;
    overflow-y: auto;
}

/* Detail: Stats grid */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: 1px;
    background: var(--border);
    margin-bottom: 1.2rem;
}
.stats-grid .sg-item {
    background: var(--elevated);
    padding: 0.8rem;
}
.stats-grid .sg-label {
    font-size: 0.6rem;
    color: var(--dim);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: 0.2rem;
}
.stats-grid .sg-value {
    font-size: 1rem;
    font-weight: 600;
    color: var(--bright);
}

/* Detail: Strategy */
.strategy-section { margin-bottom: 1.2rem; }
.strategy-section h4 {
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--silver);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    margin-bottom: 0.6rem;
}
.node-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
}
.node-tag {
    font-size: 0.7rem;
    padding: 0.25rem 0.6rem;
    border: 1px solid var(--border-mid);
    color: var(--text);
}
.node-tag.trigger { border-color: #448aff40; color: var(--blue); }
.node-tag.condition { border-color: #ffd60040; color: var(--yellow); }
.node-tag.execution { border-color: #00c85340; color: var(--green); }
.node-tag.risk { border-color: #ff174440; color: var(--red); }

/* Detail: Trades table */
.trades-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.75rem;
}
.trades-table th {
    background: var(--elevated);
    padding: 0.5rem 0.6rem;
    text-align: left;
    font-weight: 500;
    color: var(--dim);
    text-transform: uppercase;
    letter-spacing: 0.06em;
    font-size: 0.6rem;
    border-bottom: 1px solid var(--border-mid);
    position: sticky;
    top: 0;
}
.trades-table td {
    padding: 0.4rem 0.6rem;
    border-bottom: 1px solid var(--border);
}

/* Detail: Equity chart */
.equity-chart {
    width: 100%;
    height: 200px;
    background: var(--elevated);
    border: 1px solid var(--border);
    position: relative;
}
.equity-chart canvas { width: 100%; height: 100%; }

/* Detail: Positions */
.positions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 0.8rem;
}
.pos-card {
    background: var(--elevated);
    border: 1px solid var(--border);
    padding: 0.8rem;
}
.pos-card .contract-name {
    font-size: 0.8rem;
    color: var(--bright);
    font-weight: 500;
    margin-bottom: 0.4rem;
}
.pos-card .pos-row {
    display: flex;
    justify-content: space-between;
    font-size: 0.7rem;
    margin-bottom: 0.2rem;
}
.pos-card .pos-row .lbl { color: var(--dim); }

/* Scrollbar */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: var(--black); }
::-webkit-scrollbar-thumb { background: var(--border-mid); }
::-webkit-scrollbar-thumb:hover { background: var(--dim); }

/* Empty state */
.empty-state {
    text-align: center;
    padding: 3rem;
    color: var(--dim);
    font-size: 0.8rem;
}

/* Loading */
.loading {
    text-align: center;
    padding: 2rem;
    color: var(--dim);
    font-size: 0.8rem;
}
.loading::after {
    content: '';
    display: inline-block;
    width: 12px;
    height: 12px;
    border: 2px solid var(--border-mid);
    border-top-color: var(--green);
    border-radius: 50%;
    margin-left: 0.5rem;
    vertical-align: middle;
    animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* Responsive */
@media (max-width: 900px) {
    .stats-bar { flex-wrap: wrap; }
    .stat-card { min-width: 120px; }
    .toolbar { flex-wrap: wrap; }
}
    </style>
</head>
<body>

<!-- ── Login Screen ─────────────────────────────────────── -->
<div id="login-screen">
    <h1>Mercury Admin</h1>
    <div class="login-box">
        <input type="password" id="admin-key-input" placeholder="Admin key..." autofocus>
        <button id="login-btn">Enter</button>
    </div>
    <div id="login-error"></div>
</div>

<!-- ── Dashboard ────────────────────────────────────────── -->
<div id="dashboard">

    <!-- Stats bar -->
    <div class="stats-bar" id="stats-bar">
        <div class="stat-card"><div class="label">Users</div><div class="value" id="stat-users">—</div></div>
        <div class="stat-card"><div class="label">Total Bots</div><div class="value" id="stat-bots">—</div></div>
        <div class="stat-card"><div class="label">Active</div><div class="value green" id="stat-active">—</div></div>
        <div class="stat-card"><div class="label">Total Trades</div><div class="value" id="stat-trades">—</div></div>
        <div class="stat-card"><div class="label">Top P&amp;L%</div><div class="value green" id="stat-top-pnl">—</div></div>
        <div class="stat-card"><div class="label">Avg Win Rate</div><div class="value" id="stat-avg-wr">—</div></div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
        <h2>Bot Leaderboard</h2>
        <div class="filter-group">
            <label>Sort</label>
            <select id="sort-select">
                <option value="pnl_pct">P&amp;L %</option>
                <option value="total_pnl">Total P&amp;L</option>
                <option value="sharpe">Sharpe</option>
                <option value="win_rate">Win Rate</option>
                <option value="total_trades">Trades</option>
                <option value="max_drawdown">Drawdown</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Mode</label>
            <select id="mode-select">
                <option value="all">All</option>
                <option value="paper">Paper</option>
                <option value="live">Live</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Min Trades</label>
            <input type="number" id="min-trades-input" value="5" min="0" max="1000" style="width:60px">
        </div>
        <button id="refresh-btn">Refresh</button>
    </div>

    <!-- Leaderboard -->
    <div class="table-wrap">
        <table id="leaderboard-table">
            <thead>
                <tr>
                    <th style="width:40px">#</th>
                    <th data-sort="bot_name">Bot</th>
                    <th data-sort="user_id">User</th>
                    <th data-sort="status">Status</th>
                    <th data-sort="mode">Mode</th>
                    <th data-sort="platform">Platform</th>
                    <th data-sort="total_pnl_pct">P&amp;L%</th>
                    <th data-sort="total_pnl">P&amp;L $</th>
                    <th data-sort="sharpe_ratio">Sharpe</th>
                    <th data-sort="win_rate">Win%</th>
                    <th data-sort="max_drawdown">DD%</th>
                    <th data-sort="total_trades">Trades</th>
                    <th data-sort="days_active">Days</th>
                    <th>Equity</th>
                    <th style="width:60px">Fund</th>
                </tr>
            </thead>
            <tbody id="leaderboard-body"></tbody>
        </table>
    </div>

    <!-- Detail Panel -->
    <div id="detail-panel">
        <div class="detail-header">
            <h3 id="detail-bot-name">—</h3>
            <span class="meta" id="detail-bot-meta"></span>
            <button class="close-btn" id="detail-close">Close [Esc]</button>
        </div>
        <div class="detail-tabs">
            <button class="active" data-tab="overview">Overview</button>
            <button data-tab="strategy">Strategy</button>
            <button data-tab="trades">Trades</button>
            <button data-tab="equity">Equity</button>
            <button data-tab="positions">Positions</button>
        </div>
        <div class="detail-content" id="detail-content"></div>
    </div>
</div>

<script>
/* ================================================================
   MERCURY ADMIN DASHBOARD
   ================================================================ */
(function() {
    'use strict';

    // ── Config ──
    const ENGINE_BASE = window.MERCURY_ENGINE_BASE
        || (location.hostname === 'localhost' || location.hostname === '127.0.0.1'
            ? 'http://localhost:8778' : `${location.origin}`);

    let ADMIN_KEY = sessionStorage.getItem('mercury_admin_key') || '';
    let leaderboardData = [];
    let selectedBotId = null;
    let detailCache = {};
    let fundingFlags = JSON.parse(localStorage.getItem('mercury_funding_flags') || '{}');

    // ── Helpers ──
    function esc(s) {
        if (!s) return '';
        const d = document.createElement('div');
        d.textContent = String(s);
        return d.innerHTML;
    }

    function fmt(n, decimals = 2) {
        if (n == null || isNaN(n)) return '—';
        return Number(n).toLocaleString('en-US', {
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals,
        });
    }

    function pnlClass(val) {
        if (val > 0) return 'pos';
        if (val < 0) return 'neg';
        return 'muted';
    }

    function statusDot(status) {
        const s = (status || '').toLowerCase();
        return `<span class="status-dot ${s}"></span>${esc(status)}`;
    }

    function rankClass(i) {
        if (i === 0) return 'gold';
        if (i === 1) return 'silver-rank';
        if (i === 2) return 'bronze';
        return '';
    }

    // ── Sparkline SVG ──
    function sparklineSVG(data) {
        if (!data || data.length < 2) return '';
        const w = 80, h = 24, pad = 2;
        const min = Math.min(...data);
        const max = Math.max(...data);
        const range = max - min || 1;
        const points = data.map((v, i) => {
            const x = pad + (i / (data.length - 1)) * (w - 2 * pad);
            const y = pad + (1 - (v - min) / range) * (h - 2 * pad);
            return `${x},${y}`;
        }).join(' ');
        const color = data[data.length - 1] >= data[0] ? 'var(--green)' : 'var(--red)';
        return `<svg viewBox="0 0 ${w} ${h}" preserveAspectRatio="none">
            <polyline points="${points}" fill="none" stroke="${color}" stroke-width="1.5" vector-effect="non-scaling-stroke"/>
        </svg>`;
    }

    // ── API calls ──
    async function apiFetch(path) {
        const resp = await fetch(`${ENGINE_BASE}${path}`, {
            headers: { 'X-Admin-Key': ADMIN_KEY }
        });
        if (resp.status === 403) throw new Error('Unauthorized');
        if (!resp.ok) throw new Error(`API error ${resp.status}`);
        return resp.json();
    }

    // ── Login ──
    const loginScreen = document.getElementById('login-screen');
    const dashboard = document.getElementById('dashboard');
    const loginBtn = document.getElementById('login-btn');
    const keyInput = document.getElementById('admin-key-input');
    const loginError = document.getElementById('login-error');

    async function attemptLogin() {
        const key = keyInput.value.trim();
        if (!key) { loginError.textContent = 'Enter admin key'; return; }
        ADMIN_KEY = key;
        try {
            await apiFetch('/api/admin/stats');
            sessionStorage.setItem('mercury_admin_key', key);
            loginScreen.style.display = 'none';
            dashboard.style.display = 'block';
            loadDashboard();
        } catch {
            loginError.textContent = 'Invalid key';
            ADMIN_KEY = '';
        }
    }

    loginBtn.addEventListener('click', attemptLogin);
    keyInput.addEventListener('keydown', e => { if (e.key === 'Enter') attemptLogin(); });

    // Auto-login if key cached
    if (ADMIN_KEY) {
        apiFetch('/api/admin/stats').then(() => {
            loginScreen.style.display = 'none';
            dashboard.style.display = 'block';
            loadDashboard();
        }).catch(() => {
            ADMIN_KEY = '';
            sessionStorage.removeItem('mercury_admin_key');
        });
    }

    // ── Load Dashboard ──
    async function loadDashboard() {
        await Promise.all([loadStats(), loadLeaderboard()]);
    }

    async function loadStats() {
        try {
            const s = await apiFetch('/api/admin/stats');
            document.getElementById('stat-users').textContent = s.total_users || 0;
            document.getElementById('stat-bots').textContent = s.total_bots || 0;
            document.getElementById('stat-active').textContent = s.active_bots || 0;
            document.getElementById('stat-trades').textContent = (s.total_trades || 0).toLocaleString();
            document.getElementById('stat-top-pnl').textContent = s.top_pnl_pct != null ? `${fmt(s.top_pnl_pct, 1)}%` : '—';
            document.getElementById('stat-avg-wr').textContent = s.avg_win_rate != null ? `${fmt(s.avg_win_rate, 1)}%` : '—';
        } catch (e) {
            console.error('Stats load failed:', e);
        }
    }

    async function loadLeaderboard() {
        const tbody = document.getElementById('leaderboard-body');
        tbody.innerHTML = '<tr><td colspan="15" class="loading">Loading leaderboard</td></tr>';

        const sortBy = document.getElementById('sort-select').value;
        const mode = document.getElementById('mode-select').value;
        const minTrades = document.getElementById('min-trades-input').value || 5;

        try {
            leaderboardData = await apiFetch(
                `/api/admin/leaderboard?sort_by=${sortBy}&mode=${mode}&limit=200&min_trades=${minTrades}`
            );
            renderLeaderboard();
        } catch (e) {
            tbody.innerHTML = `<tr><td colspan="15" class="empty-state">Failed to load: ${esc(e.message)}</td></tr>`;
        }
    }

    function renderLeaderboard() {
        const tbody = document.getElementById('leaderboard-body');
        if (!leaderboardData.length) {
            tbody.innerHTML = '<tr><td colspan="15" class="empty-state">No bots match filters</td></tr>';
            return;
        }

        tbody.innerHTML = leaderboardData.map((b, i) => {
            const isFlagged = fundingFlags[b.bot_id];
            return `<tr data-bot-id="${esc(b.bot_id)}" class="${selectedBotId === b.bot_id ? 'selected' : ''}">
                <td class="rank-cell ${rankClass(i)}">${i + 1}</td>
                <td>${esc(b.bot_name)}</td>
                <td class="muted" title="${esc(b.user_id)}">${esc((b.user_id || '').slice(0, 8))}...</td>
                <td>${statusDot(b.status)}</td>
                <td>${esc(b.mode)}</td>
                <td>${esc(b.platform || '—')}</td>
                <td class="${pnlClass(b.total_pnl_pct)}">${fmt(b.total_pnl_pct, 1)}%</td>
                <td class="${pnlClass(b.total_pnl)}">$${fmt(b.total_pnl)}</td>
                <td>${fmt(b.sharpe_ratio)}</td>
                <td>${fmt(b.win_rate, 1)}%</td>
                <td>${fmt(b.max_drawdown, 1)}%</td>
                <td>${b.total_trades}</td>
                <td class="muted">${b.days_active}d</td>
                <td><div class="spark-container">${sparklineSVG(b.spark_data)}</div></td>
                <td><span class="funding-flag ${isFlagged ? '' : 'unflagged'}"
                          data-flag-id="${esc(b.bot_id)}">${isFlagged ? 'FLAGGED' : 'FLAG'}</span></td>
            </tr>`;
        }).join('');
    }

    // ── Table click handlers ──
    document.getElementById('leaderboard-body').addEventListener('click', e => {
        // Funding flag toggle
        const flagEl = e.target.closest('.funding-flag');
        if (flagEl) {
            const id = flagEl.dataset.flagId;
            if (fundingFlags[id]) {
                delete fundingFlags[id];
            } else {
                fundingFlags[id] = true;
            }
            localStorage.setItem('mercury_funding_flags', JSON.stringify(fundingFlags));
            renderLeaderboard();
            return;
        }

        // Row click → open detail
        const row = e.target.closest('tr[data-bot-id]');
        if (row) {
            const botId = row.dataset.botId;
            if (selectedBotId === botId) {
                closeDetail();
            } else {
                openDetail(botId);
            }
        }
    });

    // ── Column sort ──
    document.querySelectorAll('thead th[data-sort]').forEach(th => {
        th.addEventListener('click', () => {
            const key = th.dataset.sort;
            // Client-side re-sort of current data
            const isAsc = th.classList.contains('sorted') && !th.classList.contains('asc');
            document.querySelectorAll('thead th').forEach(h => h.classList.remove('sorted', 'asc'));
            th.classList.add('sorted');
            if (isAsc) th.classList.add('asc');

            leaderboardData.sort((a, b) => {
                let av = a[key], bv = b[key];
                if (typeof av === 'string') av = av.toLowerCase();
                if (typeof bv === 'string') bv = bv.toLowerCase();
                if (av < bv) return isAsc ? -1 : 1;
                if (av > bv) return isAsc ? 1 : -1;
                return 0;
            });
            renderLeaderboard();
        });
    });

    // ── Toolbar controls ──
    document.getElementById('sort-select').addEventListener('change', loadLeaderboard);
    document.getElementById('mode-select').addEventListener('change', loadLeaderboard);
    document.getElementById('min-trades-input').addEventListener('change', loadLeaderboard);
    document.getElementById('refresh-btn').addEventListener('click', loadDashboard);

    // ── Detail Panel ──
    const detailPanel = document.getElementById('detail-panel');
    const detailContent = document.getElementById('detail-content');
    let activeTab = 'overview';

    async function openDetail(botId) {
        selectedBotId = botId;
        detailPanel.classList.add('open');
        renderLeaderboard();

        // Find bot summary from leaderboard
        const botSummary = leaderboardData.find(b => b.bot_id === botId);
        document.getElementById('detail-bot-name').textContent = botSummary ? botSummary.bot_name : botId;
        document.getElementById('detail-bot-meta').textContent = botSummary
            ? `${botSummary.user_id} · ${botSummary.mode} · ${botSummary.platform || 'Unknown'}`
            : '';

        // Load full detail
        if (!detailCache[botId]) {
            detailContent.innerHTML = '<div class="loading">Loading bot detail</div>';
            try {
                detailCache[botId] = await apiFetch(`/api/admin/bots/${botId}/full`);
            } catch (e) {
                detailContent.innerHTML = `<div class="empty-state">Failed: ${esc(e.message)}</div>`;
                return;
            }
        }
        renderDetailTab(activeTab);
    }

    function closeDetail() {
        selectedBotId = null;
        detailPanel.classList.remove('open');
        renderLeaderboard();
    }

    document.getElementById('detail-close').addEventListener('click', closeDetail);
    document.addEventListener('keydown', e => {
        if (e.key === 'Escape' && selectedBotId) closeDetail();
    });

    // Detail tabs
    document.querySelectorAll('.detail-tabs button').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.detail-tabs button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            activeTab = btn.dataset.tab;
            if (selectedBotId && detailCache[selectedBotId]) {
                renderDetailTab(activeTab);
            }
        });
    });

    function renderDetailTab(tab) {
        const data = detailCache[selectedBotId];
        if (!data) return;

        switch (tab) {
            case 'overview': renderOverview(data); break;
            case 'strategy': renderStrategy(data); break;
            case 'trades': renderTrades(data); break;
            case 'equity': renderEquity(data); break;
            case 'positions': renderPositions(data); break;
        }
    }

    // ── Tab: Overview ──
    function renderOverview(data) {
        const b = data.bot;
        detailContent.innerHTML = `
            <div class="stats-grid">
                <div class="sg-item"><div class="sg-label">Initial Capital</div><div class="sg-value">$${fmt(b.initial_capital)}</div></div>
                <div class="sg-item"><div class="sg-label">Current Capital</div><div class="sg-value">$${fmt(b.current_capital)}</div></div>
                <div class="sg-item"><div class="sg-label">Total P&amp;L</div><div class="sg-value" style="color:${b.total_pnl >= 0 ? 'var(--green)' : 'var(--red)'}">$${fmt(b.total_pnl)}</div></div>
                <div class="sg-item"><div class="sg-label">P&amp;L %</div><div class="sg-value" style="color:${b.total_pnl_pct >= 0 ? 'var(--green)' : 'var(--red)'}">${fmt(b.total_pnl_pct, 1)}%</div></div>
                <div class="sg-item"><div class="sg-label">Sharpe Ratio</div><div class="sg-value">${fmt(b.sharpe_ratio)}</div></div>
                <div class="sg-item"><div class="sg-label">Win Rate</div><div class="sg-value">${fmt(b.win_rate, 1)}%</div></div>
                <div class="sg-item"><div class="sg-label">Max Drawdown</div><div class="sg-value" style="color:var(--red)">${fmt(b.max_drawdown, 1)}%</div></div>
                <div class="sg-item"><div class="sg-label">Total Trades</div><div class="sg-value">${b.total_trades}</div></div>
                <div class="sg-item"><div class="sg-label">Wins / Losses</div><div class="sg-value">${b.wins} / ${b.losses}</div></div>
                <div class="sg-item"><div class="sg-label">Eval Cycles</div><div class="sg-value">${(b.eval_count || 0).toLocaleString()}</div></div>
                <div class="sg-item"><div class="sg-label">Created</div><div class="sg-value">${esc(b.created_at || '—')}</div></div>
                <div class="sg-item"><div class="sg-label">Started</div><div class="sg-value">${esc(b.started_at || '—')}</div></div>
            </div>
            <div style="font-size:0.7rem; color:var(--dim);">Bot ID: ${esc(b.id)}<br>User ID: ${esc(b.user_id)}</div>
        `;
    }

    // ── Tab: Strategy ──
    function renderStrategy(data) {
        const ss = data.strategy_stats || {};
        const strat = data.strategy;

        let html = '<div class="strategy-section">';
        html += `<h4>Node Summary (${ss.node_count || 0} nodes)</h4>`;

        const sections = [
            { label: 'Triggers', types: ss.trigger_types, cls: 'trigger' },
            { label: 'Conditions', types: ss.condition_types, cls: 'condition' },
            { label: 'Executions', types: ss.execution_types, cls: 'execution' },
            { label: 'Risk', types: ss.risk_types, cls: 'risk' },
        ];

        for (const sec of sections) {
            if (sec.types && sec.types.length) {
                html += `<div style="margin-bottom:0.8rem;"><span style="font-size:0.65rem;color:var(--dim);text-transform:uppercase;letter-spacing:0.08em;">${sec.label}</span><div class="node-list" style="margin-top:0.3rem;">`;
                for (const t of sec.types) {
                    html += `<span class="node-tag ${sec.cls}">${esc(t)}</span>`;
                }
                html += '</div></div>';
            }
        }
        html += '</div>';

        // Full pipeline JSON
        if (strat && strat.pipeline) {
            html += '<div class="strategy-section"><h4>Full Pipeline Config</h4>';
            html += `<pre style="background:var(--elevated);border:1px solid var(--border);padding:0.8rem;overflow-x:auto;font-size:0.7rem;color:var(--text);max-height:400px;overflow-y:auto;">${esc(JSON.stringify(strat.pipeline, null, 2))}</pre>`;
            html += '</div>';
        }

        // Asset config
        if (strat && strat.config) {
            html += '<div class="strategy-section"><h4>Strategy Config</h4>';
            html += `<pre style="background:var(--elevated);border:1px solid var(--border);padding:0.8rem;overflow-x:auto;font-size:0.7rem;color:var(--text);">${esc(JSON.stringify(strat.config, null, 2))}</pre>`;
            html += '</div>';
        }

        detailContent.innerHTML = html;
    }

    // ── Tab: Trades ──
    function renderTrades(data) {
        const trades = data.trades || [];
        if (!trades.length) {
            detailContent.innerHTML = '<div class="empty-state">No trades recorded</div>';
            return;
        }

        let html = `<div style="margin-bottom:0.6rem;font-size:0.7rem;color:var(--dim);">${trades.length} total trades</div>`;
        html += '<table class="trades-table"><thead><tr>';
        html += '<th>Time</th><th>Side</th><th>Contract</th><th>Price</th><th>Qty</th><th>Amount</th><th>P&amp;L</th><th>Fees</th><th>Trigger</th><th>Execution</th>';
        html += '</tr></thead><tbody>';

        // Show most recent first
        const reversed = [...trades].reverse();
        for (const t of reversed) {
            const sideColor = t.side === 'buy' ? 'var(--green)' : 'var(--red)';
            html += `<tr>
                <td class="muted">${esc((t.timestamp || '').replace('T', ' ').slice(0, 19))}</td>
                <td style="color:${sideColor};font-weight:500;">${esc(t.side)}</td>
                <td>${esc(t.contract || '—')}</td>
                <td>${fmt(t.price, 4)}</td>
                <td>${t.quantity || '—'}</td>
                <td>$${fmt(t.amount)}</td>
                <td class="${pnlClass(t.pnl)}">$${fmt(t.pnl)}</td>
                <td class="muted">$${fmt(t.fees)}</td>
                <td class="muted">${esc(t.trigger_node || '—')}</td>
                <td class="muted">${esc(t.execution_node || '—')}</td>
            </tr>`;
        }

        html += '</tbody></table>';
        detailContent.innerHTML = html;
    }

    // ── Tab: Equity ──
    function renderEquity(data) {
        const eq = data.equity_history || [];
        if (!eq.length) {
            detailContent.innerHTML = '<div class="empty-state">No equity history</div>';
            return;
        }

        const initial = data.bot.initial_capital || eq[0];

        detailContent.innerHTML = `
            <div style="margin-bottom:0.6rem;font-size:0.7rem;color:var(--dim);">${eq.length} data points · Initial: $${fmt(initial)} · Current: $${fmt(eq[eq.length - 1])}</div>
            <div class="equity-chart"><canvas id="equity-canvas"></canvas></div>
        `;

        // Draw on canvas
        requestAnimationFrame(() => {
            const canvas = document.getElementById('equity-canvas');
            if (!canvas) return;
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            const ctx = canvas.getContext('2d');
            const W = canvas.width, H = canvas.height;
            const pad = { t: 20, r: 60, b: 20, l: 10 };

            const min = Math.min(...eq);
            const max = Math.max(...eq);
            const range = max - min || 1;

            // Grid lines
            ctx.strokeStyle = '#1a1a1a';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 4; i++) {
                const y = pad.t + (i / 4) * (H - pad.t - pad.b);
                ctx.beginPath();
                ctx.moveTo(pad.l, y);
                ctx.lineTo(W - pad.r, y);
                ctx.stroke();

                // Label
                const val = max - (i / 4) * range;
                ctx.fillStyle = '#444444';
                ctx.font = '9px JetBrains Mono';
                ctx.textAlign = 'left';
                ctx.fillText(`$${val.toFixed(0)}`, W - pad.r + 4, y + 3);
            }

            // Initial capital line
            const initY = pad.t + (1 - (initial - min) / range) * (H - pad.t - pad.b);
            ctx.strokeStyle = '#333333';
            ctx.setLineDash([4, 4]);
            ctx.beginPath();
            ctx.moveTo(pad.l, initY);
            ctx.lineTo(W - pad.r, initY);
            ctx.stroke();
            ctx.setLineDash([]);

            // Equity line
            const isUp = eq[eq.length - 1] >= initial;
            ctx.strokeStyle = isUp ? '#00c853' : '#ff1744';
            ctx.lineWidth = 1.5;
            ctx.beginPath();
            for (let i = 0; i < eq.length; i++) {
                const x = pad.l + (i / (eq.length - 1)) * (W - pad.l - pad.r);
                const y = pad.t + (1 - (eq[i] - min) / range) * (H - pad.t - pad.b);
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();

            // Fill under curve
            const lastX = pad.l + ((eq.length - 1) / (eq.length - 1)) * (W - pad.l - pad.r);
            ctx.lineTo(lastX, H - pad.b);
            ctx.lineTo(pad.l, H - pad.b);
            ctx.closePath();
            ctx.fillStyle = isUp ? 'rgba(0,200,83,0.06)' : 'rgba(255,23,68,0.06)';
            ctx.fill();
        });
    }

    // ── Tab: Positions ──
    function renderPositions(data) {
        const positions = data.positions || [];
        if (!positions.length) {
            detailContent.innerHTML = '<div class="empty-state">No open positions</div>';
            return;
        }

        let html = `<div style="margin-bottom:0.6rem;font-size:0.7rem;color:var(--dim);">${positions.length} open positions</div>`;
        html += '<div class="positions-grid">';

        for (const p of positions) {
            const pnlColor = p.unrealized_pnl >= 0 ? 'var(--green)' : 'var(--red)';
            html += `<div class="pos-card">
                <div class="contract-name">${esc(p.contract || 'Unknown')}</div>
                <div class="pos-row"><span class="lbl">Side</span><span style="color:${p.side === 'buy' ? 'var(--green)' : 'var(--red)'}">${esc(p.side)} ${esc(p.direction || '')}</span></div>
                <div class="pos-row"><span class="lbl">Entry</span><span>${fmt(p.entry_price, 4)}</span></div>
                <div class="pos-row"><span class="lbl">Current</span><span>${fmt(p.current_price, 4)}</span></div>
                <div class="pos-row"><span class="lbl">Quantity</span><span>${p.quantity}</span></div>
                <div class="pos-row"><span class="lbl">Cost Basis</span><span>$${fmt(p.cost_basis)}</span></div>
                <div class="pos-row"><span class="lbl">Unrealized P&L</span><span style="color:${pnlColor}">$${fmt(p.unrealized_pnl)}</span></div>
                <div class="pos-row"><span class="lbl">Opened</span><span class="muted">${esc((p.opened_at || '').replace('T', ' ').slice(0, 19))}</span></div>
            </div>`;
        }

        html += '</div>';
        detailContent.innerHTML = html;
    }

})();
</script>
</body>
</html>
