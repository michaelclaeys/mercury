<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-Frame-Options" content="DENY">
  <meta name="robots" content="noindex, nofollow">
  <title>Architect — Mercury</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <script>
    // Mobile detection — runs before CSS paint to prevent layout flash
    (function(){
      var m = /Android|iPhone|iPad|iPod|webOS|BlackBerry|Opera Mini|IEMobile/i.test(navigator.userAgent) || window.innerWidth <= 768;
      if(m) document.documentElement.classList.add('is-mobile');
      window.__mercury_mobile = m;
    })();
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./styles/architect-app.css?v=55">
  <link rel="stylesheet" href="./styles/charting.css?v=37">
</head>
<body>
  <!-- Mobile Menu Button -->
  <button class="mobile-menu-btn" id="mobileMenuBtn">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </button>

  <!-- Sidebar Overlay -->
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <!-- ════════ SIDEBAR ════════ -->
  <aside class="sidebar" id="sidebar">
    <a href="index.html" class="sidebar-logo">
      <svg class="logo-orbit" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <circle cx="12" cy="12" r="3"/>
        <ellipse cx="12" cy="12" rx="10" ry="4" transform="rotate(30 12 12)"/>
        <ellipse cx="12" cy="12" rx="10" ry="4" transform="rotate(-30 12 12)"/>
      </svg>
      <div class="logo-text-group">
        <span class="logo-name">Mercury</span>
        <span class="logo-sub">Architect</span>
      </div>
    </a>

    <nav class="sidebar-nav">
      <a href="#" class="nav-item nav-item--primary active" data-view="builder">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="3"/>
          <ellipse cx="12" cy="12" rx="10" ry="4" transform="rotate(30 12 12)"/>
          <ellipse cx="12" cy="12" rx="10" ry="4" transform="rotate(-30 12 12)"/>
        </svg>
        Agent
      </a>
      <a href="#" class="nav-item" data-view="my-bots">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="2" y="3" width="20" height="14" rx="0"></rect>
          <line x1="8" y1="21" x2="16" y2="21"></line>
          <line x1="12" y1="17" x2="12" y2="21"></line>
          <circle cx="8" cy="10" r="1" fill="currentColor"></circle>
          <circle cx="16" cy="10" r="1" fill="currentColor"></circle>
        </svg>
        My Bots
      </a>
      <a href="#" class="nav-item nav-item--primary" data-view="backtest">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
        </svg>
        Backtest
      </a>
      <a href="#" class="nav-item" data-view="templates">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="18" height="18"></rect>
          <line x1="3" y1="9" x2="21" y2="9"></line>
          <line x1="9" y1="21" x2="9" y2="9"></line>
        </svg>
        Templates
      </a>
      <a href="#" class="nav-item" data-view="charting">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="2" x2="12" y2="22"></line>
          <line x1="2" y1="12" x2="22" y2="12"></line>
          <circle cx="12" cy="12" r="4"></circle>
        </svg>
        Charting
      </a>
      <a href="#" class="nav-item nav-item--primary" data-view="portfolio">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 12V7H5a2 2 0 010-4h14v4"/>
          <path d="M3 5v14a2 2 0 002 2h16v-5"/>
          <path d="M18 12a2 2 0 100 4h4v-4h-4z"/>
        </svg>
        Portfolio
      </a>
      <a href="#" class="nav-item" data-view="bonding-arb">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 2v20M2 12h20"/>
          <circle cx="12" cy="6" r="2"/>
          <circle cx="12" cy="18" r="2"/>
          <path d="M6 8l6-2 6 2M6 16l6 2 6-2"/>
        </svg>
        One Click Bonds
      </a>
      <a href="#" class="nav-item" data-view="catalyst">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M2 12h4l3-9 4 18 3-9h6"/>
        </svg>
        Catalyst
      </a>

      <div class="nav-separator"></div>

      <a href="index.html" class="nav-item nav-item--home">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
          <polyline points="9 22 9 12 15 12 15 22"></polyline>
        </svg>
        Suite Home
      </a>
      <a href="/funding.html" class="nav-item nav-item--funding">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="2" y="6" width="20" height="14" rx="0"/>
          <path d="M16 14a2 2 0 100-4 2 2 0 000 4z"/>
          <path d="M2 10h20"/>
        </svg>
        Funding
      </a>
    </nav>

    <!-- Connected Accounts -->
    <div class="sidebar-accounts">
      <div class="accounts-title">Connected Accounts</div>
      <div class="account-row" id="accountPolymarket">
        <span class="account-dot disconnected"></span>
        <span class="account-name">Polymarket</span>
        <button class="account-btn" id="btnConnectPoly" onclick="openConnectModal('polymarket')">Connect</button>
      </div>
      <div class="account-row" id="accountKalshi">
        <span class="account-dot disconnected"></span>
        <span class="account-name">Kalshi</span>
        <button class="account-btn" id="btnConnectKalshi" onclick="openConnectModal('kalshi')">Connect</button>
      </div>
    </div>


    <div class="sidebar-pref">
      <label class="skip-anim-label">
        <input type="checkbox" id="skipAnimToggle" onchange="toggleSkipAnimations(this.checked)">
        <span class="skip-anim-text">Skip animations</span>
      </label>
    </div>

    <div class="sidebar-footer">
      <div class="user-info" onclick="openProfileModal()" style="cursor:pointer;" title="Account settings">
        <div class="user-avatar" id="userAvatar">?</div>
        <div class="user-details">
          <span class="user-name" id="userName">Loading...</span>
          <span class="user-plan" id="userPlan">Free Plan</span>
        </div>
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color:var(--dim);flex-shrink:0;">
          <path d="M9 18l6-6-6-6"/>
        </svg>
      </div>
      <button class="sign-out-btn" onclick="window.signOut()">Sign Out</button>
    </div>
  </aside>

  <!-- ════════ MAIN CONTENT ════════ -->
  <main class="main-content">

    <!-- ──────────────────────────────────────────────────────
         VIEW 1: BOT BUILDER
    ────────────────────────────────────────────────────── -->
    <section id="view-builder" class="app-view active">

      <!-- ── TUTORIAL (first-time users) ────────────── -->
      <div class="wizard-overlay" id="wizardOverlay">
        <div class="wizard">
          <!-- Progress -->
          <div class="wizard-progress">
            <div class="wizard-step active" data-step="1"><span class="wiz-dot"></span>Welcome</div>
            <div class="wizard-step" data-step="2"><span class="wiz-dot"></span>Blocks</div>
            <div class="wizard-step" data-step="3"><span class="wiz-dot"></span>Canvas</div>
            <div class="wizard-step" data-step="4"><span class="wiz-dot"></span>Agent</div>
            <div class="wizard-step" data-step="5"><span class="wiz-dot"></span>Catalyst</div>
            <div class="wizard-step" data-step="6"><span class="wiz-dot"></span>Start</div>
          </div>

          <!-- Step 1: Welcome -->
          <div class="wizard-page active" id="wizStep1">
            <div class="tut-hero-icon">
              <svg width="40" height="40" viewBox="0 0 100 100" fill="none" stroke="currentColor" stroke-width="3">
                <circle cx="50" cy="50" r="8" fill="currentColor"/>
                <ellipse cx="50" cy="50" rx="40" ry="14" transform="rotate(30 50 50)"/>
                <ellipse cx="50" cy="50" rx="40" ry="14" transform="rotate(-30 50 50)"/>
                <ellipse cx="50" cy="50" rx="40" ry="14" transform="rotate(90 50 50)"/>
              </svg>
            </div>
            <h2 class="wizard-title">Welcome to Architect</h2>
            <p class="wizard-subtitle">Production-grade infrastructure for prediction market trading. Pre-built building blocks, real-time data, and one-click deploy — paper trade free, go live when ready.</p>
            <div class="tut-features">
              <div class="tut-feature">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
                <span>Pre-built triggers, logic, execution, and risk blocks</span>
              </div>
              <div class="tut-feature">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
                <span>One-click deploy to production infrastructure</span>
              </div>
              <div class="tut-feature">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                <span>Paper trade free — no credit card required</span>
              </div>
            </div>
            <button class="wizard-next-btn tut-start-btn" onclick="wizardGoToStep(2)">Show me how it works</button>
          </div>

          <!-- Step 2: Strategy Builder -->
          <div class="wizard-page" id="wizStep2">
            <h2 class="wizard-title">Build with pre-built building blocks</h2>
            <p class="wizard-subtitle">Mercury provides ready-to-use components for every layer of your strategy. Drag, connect, and deploy &mdash; or describe what you want in the agent chat.</p>
            <div class="tut-ai-examples">
              <div class="tut-ai-example">
                <span class="tut-ai-prompt" style="color:var(--green);">&#9632;</span>
                <span class="tut-ai-text">Data triggers: polling shifts, price moves, news events, sentiment spikes, custom API webhooks</span>
              </div>
              <div class="tut-ai-example">
                <span class="tut-ai-prompt" style="color:#448aff;">&#9632;</span>
                <span class="tut-ai-text">Logic blocks: AND/OR gates, probability filters, cross-platform price checks, time windows</span>
              </div>
              <div class="tut-ai-example">
                <span class="tut-ai-prompt" style="color:#ffab00;">&#9632;</span>
                <span class="tut-ai-text">Execution: market/limit orders, DCA, position sizing, multi-platform routing to Polymarket &amp; Kalshi</span>
              </div>
              <div class="tut-ai-example">
                <span class="tut-ai-prompt" style="color:#ff5252;">&#9632;</span>
                <span class="tut-ai-text">Risk controls: stop-loss, max exposure, take-profit, portfolio kill switch &mdash; all built in</span>
              </div>
              <div class="tut-ai-example" style="margin-top:10px; border-top:1px solid rgba(255,255,255,0.06); padding-top:10px;">
                <span class="tut-ai-prompt" style="color:#a78bfa;">&#9632;</span>
                <span class="tut-ai-text">Event-driven: Twitter sentiment spikes, NWS weather alerts, USGS earthquake data, social buzz detection, whale order tracking, RSI/MACD/Bollinger on probability curves</span>
              </div>
            </div>
            <div class="tut-tips">
              <div class="tut-tip">Use the agent chat on the right to describe strategies in plain English &mdash; it assembles the blocks for you.</div>
              <div class="tut-tip">Or drag blocks from the + menu and connect them manually for full control.</div>
            </div>
            <div class="wizard-nav">
              <button class="wizard-back-btn" onclick="wizardGoToStep(1)">&larr; Back</button>
              <button class="wizard-next-btn" onclick="wizardGoToStep(3)">Next &rarr;</button>
            </div>
          </div>

          <!-- Step 3: Canvas (for power users) -->
          <div class="wizard-page" id="wizStep3">
            <h2 class="wizard-title">Fine-tune on the canvas</h2>
            <p class="wizard-subtitle">After the AI builds your strategy, you can tweak anything visually. Or build from scratch if you prefer full control.</p>
            <div class="tut-node-grid">
              <div class="tut-node-item">
                <span class="tut-node-dot" style="background: #00c853"></span>
                <div class="tut-node-info">
                  <span class="tut-node-name">Triggers</span>
                  <span class="tut-node-desc">Start the chain &mdash; price, volume, time, external signals</span>
                </div>
              </div>
              <div class="tut-node-item">
                <span class="tut-node-dot" style="background: #448aff"></span>
                <div class="tut-node-info">
                  <span class="tut-node-name">Logic</span>
                  <span class="tut-node-desc">Filter &mdash; probability bands, liquidity checks, correlations</span>
                </div>
              </div>
              <div class="tut-node-item">
                <span class="tut-node-dot" style="background: #ffab00"></span>
                <div class="tut-node-info">
                  <span class="tut-node-name">Execution</span>
                  <span class="tut-node-desc">Trade &mdash; market orders, limits, DCA, scaled entry</span>
                </div>
              </div>
              <div class="tut-node-item">
                <span class="tut-node-dot" style="background: #ff5252"></span>
                <div class="tut-node-info">
                  <span class="tut-node-name">Risk</span>
                  <span class="tut-node-desc">Protect &mdash; stop loss, max drawdown, position limits</span>
                </div>
              </div>
            </div>
            <div class="tut-tips">
              <div class="tut-tip">Click the <strong>+</strong> button to add nodes manually. Drag between ports to connect.</div>
              <div class="tut-tip">Click any node to edit its properties in the inspector panel.</div>
            </div>
            <div class="wizard-nav">
              <button class="wizard-back-btn" onclick="wizardGoToStep(2)">&larr; Back</button>
              <button class="wizard-next-btn" onclick="wizardGoToStep(4)">Next &rarr;</button>
            </div>
          </div>

          <!-- Step 4: Meet Mercury Agent -->
          <div class="wizard-page" id="wizStep4">
            <div class="tut-hero-icon" style="color:var(--silver);opacity:0.7;">
              <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/>
                <circle cx="9" cy="10" r="1" fill="currentColor" stroke="none"/>
                <circle cx="12" cy="10" r="1" fill="currentColor" stroke="none"/>
                <circle cx="15" cy="10" r="1" fill="currentColor" stroke="none"/>
              </svg>
            </div>
            <h2 class="wizard-title">Meet Mercury Agent</h2>
            <p class="wizard-subtitle">Your AI copilot for building strategies. Describe what you want in plain English &mdash; the agent assembles the blocks, wires the connections, and configures risk for you.</p>
            <div class="tut-agent-demo">
              <div class="tut-agent-msg tut-agent-msg--user">
                <span class="tut-agent-label">> you</span>
                <span>Buy YES on any Polymarket election market when polling averages cross 60%, but only if the price is still under 55 cents. Risk max $2,000 per position.</span>
              </div>
              <div class="tut-agent-msg tut-agent-msg--ai">
                <span class="tut-agent-label">> mercury.ai</span>
                <span>Built: <strong>polling_momentum_bot</strong><br>
                  1. DATA: RealClearPolitics polling feed<br>
                  2. TRIGGER: Rolling avg crosses 60%<br>
                  3. FILTER: Market P(YES) &lt; $0.55<br>
                  4. EXECUTE: Buy YES @ limit P+2c<br>
                  5. RISK: $2,000 max / stop-loss at -25%<br><br>
                  Deploy now or backtest first?</span>
              </div>
              <div class="tut-agent-msg tut-agent-msg--user" style="margin-top:12px; opacity:0.6;">
                <span class="tut-agent-label">> you</span>
                <span>Build a strategy that buys YES when Twitter sentiment spikes bullish and NWS issues a hurricane warning</span>
              </div>
            </div>
            <div class="tut-tips">
              <div class="tut-tip">The agent panel is always open on the right side of the canvas.</div>
              <div class="tut-tip">You can iterate &mdash; ask it to change risk limits, add data sources, or adjust execution.</div>
            </div>
            <div class="wizard-nav">
              <button class="wizard-back-btn" onclick="wizardGoToStep(3)">&larr; Back</button>
              <button class="wizard-next-btn" onclick="wizardGoToStep(5)">Next &rarr;</button>
            </div>
          </div>

          <!-- Step 5: Catalyst -->
          <div class="wizard-page" id="wizStep5">
            <div class="tut-hero-icon" style="color:var(--green);opacity:0.7;">
              <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M2 12h4l3-9 4 18 3-9h6"/>
              </svg>
            </div>
            <h2 class="wizard-title">Catalyst &mdash; Keyword Intelligence</h2>
            <p class="wizard-subtitle">Real-time keyword spike detection across news headlines. Spot narrative shifts before they move markets.</p>
            <div class="tut-ai-examples">
              <div class="tut-ai-example">
                <span class="tut-ai-prompt" style="color:var(--green);">&#9650;</span>
                <span class="tut-ai-text">Tracks keyword frequency across 7 Google News RSS feeds &mdash; crypto, politics, economy, AI, geopolitics, sports, and top stories</span>
              </div>
              <div class="tut-ai-example">
                <span class="tut-ai-prompt" style="color:#f7931a;">&#9632;</span>
                <span class="tut-ai-text">Spike detection uses 24-hour rolling baseline + standard deviation &mdash; only flags statistically significant surges, not noise</span>
              </div>
              <div class="tut-ai-example">
                <span class="tut-ai-prompt" style="color:#7c4dff;">&#9632;</span>
                <span class="tut-ai-text">Recent change column shows mention count deltas between readings so you can see momentum building in real time</span>
              </div>
              <div class="tut-ai-example">
                <span class="tut-ai-prompt" style="color:#e53935;">&#9632;</span>
                <span class="tut-ai-text">Auto-categorizes keywords into crypto, politics, economy, AI/tech, geopolitics, and sports for quick filtering</span>
              </div>
            </div>
            <div class="tut-tips">
              <div class="tut-tip">Click <strong>Catalyst</strong> in the sidebar to open. Data loads instantly from client-side extraction; spike detection builds over ~30 minutes.</div>
              <div class="tut-tip">Sort by Recent Change or Spike % to surface the fastest-moving narratives.</div>
            </div>
            <div class="wizard-nav">
              <button class="wizard-back-btn" onclick="wizardGoToStep(4)">&larr; Back</button>
              <button class="wizard-next-btn" onclick="wizardGoToStep(6)">Next &rarr;</button>
            </div>
          </div>

          <!-- Step 6: Start -->
          <div class="wizard-page" id="wizStep6">
            <h2 class="wizard-title">Ready to build</h2>
            <p class="wizard-subtitle">Choose how you'd like to get started.</p>
            <div class="tut-start-options">
              <button class="tut-option tut-option--recommended" onclick="tutStartAgent()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/>
                </svg>
                <span class="tut-option-name">Describe your strategy <span class="tut-option-rec">recommended</span></span>
                <span class="tut-option-desc">Tell the agent what you want and it assembles the building blocks</span>
              </button>
              <button class="tut-option" onclick="tutStartTemplate()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <rect x="3" y="3" width="18" height="18"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/>
                </svg>
                <span class="tut-option-name">Load a template</span>
                <span class="tut-option-desc">Start with a pre-built strategy and customize it</span>
              </button>
              <button class="tut-option" onclick="tutStartBlank()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                <span class="tut-option-name">Blank canvas</span>
                <span class="tut-option-desc">Start from scratch and build node by node</span>
              </button>
            </div>
            <button class="wizard-back-btn" onclick="wizardGoToStep(5)">&larr; Back</button>
          </div>

          <button class="wizard-skip" onclick="hideWizard()">Skip tutorial &rarr;</button>
        </div>
      </div>

      <!-- Builder Body (2-panel) -->
      <div class="builder-body">

        <!-- Left: Canvas Area -->
        <div class="canvas-area">
          <!-- Slim toolbar -->
          <div class="builder-toolbar">
            <div class="toolbar-left">
              <input class="strategy-name-input" id="strategyName"
                     value="untitled_strategy" spellcheck="false">
              <span class="toolbar-divider"></span>
              <span class="toolbar-status" id="toolbarStatus">Draft</span>
            </div>
            <div class="toolbar-right">
              <button class="toolbar-btn" onclick="reopenTutorial()" title="Architect Tutorial">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"></path>
                  <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
                Architect Tutorial
              </button>
              <button class="toolbar-btn" onclick="startTour()" title="Sitewide Tour">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                  <circle cx="12" cy="12" r="3"></circle>
                </svg>
                Sitewide Tour
              </button>
              <button class="toolbar-btn" id="btnImportStrategy" title="Import Strategy">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"></path>
                  <polyline points="7 10 12 15 17 10"></polyline>
                  <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                Import
              </button>
              <button class="toolbar-btn" id="btnExportStrategy" title="Export Strategy">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"></path>
                  <polyline points="17 8 12 3 7 8"></polyline>
                  <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                Export
              </button>
              <button class="toolbar-btn" onclick="fitToView()" title="Fit all nodes to view">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"></path>
                </svg>
                Fit View
              </button>
              <button class="toolbar-btn" id="btnCommit">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="4"></circle>
                  <line x1="1.05" y1="12" x2="7" y2="12"></line>
                  <line x1="17.01" y1="12" x2="22.96" y2="12"></line>
                </svg>
                Commit
              </button>
              <button class="toolbar-btn toolbar-btn-primary" id="btnDeploy">Deploy</button>
            </div>
          </div>

          <!-- Strategy Tabs -->
          <div class="strategy-bar" id="strategyBar">
            <div class="strategy-tabs" id="strategyTabs">
              <!-- Strategy tabs populated by JS -->
            </div>
            <div class="strategy-bar-actions">
              <button class="strategy-bar-btn" id="btnNewStrategy" title="New Strategy">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="12" y1="5" x2="12" y2="19"></line>
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                New Strategy
              </button>
              <button class="strategy-bar-btn" id="btnBrowseStrategies" title="My Strategies">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"></path>
                </svg>
                My Strategies
              </button>
            </div>
          </div>

          <!-- Canvas + Script -->
          <div class="canvas-script-column">
            <div class="canvas-container" id="canvasContainer">
              <div class="canvas-agent-tip" id="canvasAgentTip">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <circle cx="12" cy="12" r="3"/><ellipse cx="12" cy="12" rx="10" ry="4" transform="rotate(30 12 12)"/><ellipse cx="12" cy="12" rx="10" ry="4" transform="rotate(-30 12 12)"/>
                </svg>
                <span>For complex strategies, custom APIs, or advanced data sources — <strong>use the Mercury Agent</strong>. Describe what you want in plain English and the AI handles the rest.</span>
                <button class="canvas-agent-tip-close" onclick="this.parentElement.style.display='none'; localStorage.setItem('mercury_agent_tip_dismissed','1');">&times;</button>
              </div>
              <div class="canvas-viewport grid-visible" id="canvasViewport">
                <svg class="connections-layer" id="connectionsLayer"></svg>
              </div>

              <!-- Agent Script Overlay (shown when AI builds a script strategy) -->
              <div class="script-overlay" id="scriptOverlay" style="display:none">
                <div class="script-overlay-header">
                  <div class="script-overlay-title">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="16 18 22 12 16 6"></polyline>
                      <polyline points="8 6 2 12 8 18"></polyline>
                    </svg>
                    <span>Strategy Script</span>
                    <span class="script-overlay-badge" id="scriptOverlayBadge">AI Generated</span>
                  </div>
                  <div class="script-overlay-actions">
                    <button class="script-overlay-btn" id="btnCopyScript" title="Copy to clipboard">
                      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                        <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"></path>
                      </svg>
                      Copy
                    </button>
                    <button class="script-overlay-btn" id="btnSwitchToNodes" title="Switch to node editor">
                      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                      </svg>
                      Switch to Nodes
                    </button>
                  </div>
                </div>
                <pre class="script-overlay-code" id="scriptOverlayCode"></pre>
                <div class="script-overlay-footer" id="scriptOverlayFooter">
                  <span class="script-overlay-status">Ready to deploy</span>
                </div>
              </div>

              <!-- Floating Node Palette -->
              <button class="floating-palette-toggle" id="btnPaletteToggle" title="Node Palette">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="12" y1="5" x2="12" y2="19"></line>
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
              </button>
              <div class="palette-tooltip" id="paletteTooltip">Add Nodes</div>
              <div class="floating-palette" id="floatingPalette">
                <div class="floating-palette-header">
                  <span>Add Node</span>
                  <button class="floating-palette-close" id="btnPaletteClose">&times;</button>
                </div>
                <input class="palette-search" placeholder="Search nodes..." id="paletteSearch">
                <div class="palette-groups" id="paletteGroups">
                  <div class="palette-group open" data-category="trigger">
                    <div class="palette-group-header">
                      <span class="palette-group-indicator">&#9656;</span>
                      <span class="palette-group-dot" style="background:#00c853"></span>
                      <span class="palette-group-name">Triggers</span>
                    </div>
                    <div class="palette-group-items">
                      <div class="palette-item" data-node-type="market" draggable="true"><span class="palette-item-icon" style="color:#00c853">&#9733;</span><span class="palette-item-name">Market</span></div>
                      <div class="palette-item" data-node-type="price-threshold" draggable="true"><span class="palette-item-icon" style="color:#00c853">&#9673;</span><span class="palette-item-name">Price Threshold</span></div>
                      <div class="palette-item" data-node-type="volume-spike" draggable="true"><span class="palette-item-icon" style="color:#00c853">&#9650;</span><span class="palette-item-name">Volume Spike</span></div>
                      <div class="palette-item" data-node-type="time-based" draggable="true"><span class="palette-item-icon" style="color:#00c853">&#9201;</span><span class="palette-item-name">Time-Based</span></div>
                      <div class="palette-item" data-node-type="market-event" draggable="true"><span class="palette-item-icon" style="color:#00c853">&#9889;</span><span class="palette-item-name">Market Event</span></div>
                      <div class="palette-item" data-node-type="probability-cross" draggable="true"><span class="palette-item-icon" style="color:#00c853">&#10539;</span><span class="palette-item-name">Probability Cross</span></div>
                      <div class="palette-item" data-node-type="api-data" draggable="true"><span class="palette-item-icon" style="color:#00c853">&#9740;</span><span class="palette-item-name">Custom API</span></div>
                      <div class="palette-item" data-node-type="news-alert" draggable="true"><span class="palette-item-icon" style="color:#00c853">&#9888;</span><span class="palette-item-name">News Alert</span></div>
                      <!-- Technical Indicators -->
                      <div class="palette-item" data-node-type="rsi" draggable="true"><span class="palette-item-icon" style="color:#00c853">&#8597;</span><span class="palette-item-name">RSI</span></div>
                      <div class="palette-item" data-node-type="macd" draggable="true"><span class="palette-item-icon" style="color:#00c853">&#8734;</span><span class="palette-item-name">MACD</span></div>
                      <div class="palette-item" data-node-type="bollinger" draggable="true"><span class="palette-item-icon" style="color:#00c853">&#9186;</span><span class="palette-item-name">Bollinger Bands</span></div>
                      <div class="palette-item" data-node-type="moving-average" draggable="true"><span class="palette-item-icon" style="color:#00c853">&#8767;</span><span class="palette-item-name">Moving Average</span></div>
                      <div class="palette-item" data-node-type="rate-of-change" draggable="true"><span class="palette-item-icon" style="color:#00c853">&#916;</span><span class="palette-item-name">Rate of Change</span></div>
                      <div class="palette-item" data-node-type="pattern" draggable="true"><span class="palette-item-icon" style="color:#00c853">&#9698;</span><span class="palette-item-name">Pattern Detect</span></div>
                    </div>
                  </div>
                  <div class="palette-group" data-category="condition">
                    <div class="palette-group-header">
                      <span class="palette-group-indicator">&#9656;</span>
                      <span class="palette-group-dot" style="background:#60a5fa"></span>
                      <span class="palette-group-name">Conditions</span>
                    </div>
                    <div class="palette-group-items">
                      <div class="palette-item" data-node-type="probability-band" draggable="true"><span class="palette-item-icon" style="color:#60a5fa">&#9670;</span><span class="palette-item-name">Probability Band</span></div>
                      <div class="palette-item" data-node-type="liquidity-check" draggable="true"><span class="palette-item-icon" style="color:#60a5fa">&#9679;</span><span class="palette-item-name">Liquidity Check</span></div>
                      <div class="palette-item" data-node-type="portfolio-exposure" draggable="true"><span class="palette-item-icon" style="color:#60a5fa">&#9645;</span><span class="palette-item-name">Portfolio Exposure</span></div>
                      <div class="palette-item" data-node-type="correlation" draggable="true"><span class="palette-item-icon" style="color:#60a5fa">&#8776;</span><span class="palette-item-name">Correlation</span></div>
                      <div class="palette-item" data-node-type="time-window" draggable="true"><span class="palette-item-icon" style="color:#60a5fa">&#9200;</span><span class="palette-item-name">Time Window</span></div>
                      <div class="palette-item" data-node-type="spread-check" draggable="true"><span class="palette-item-icon" style="color:#60a5fa">&#8596;</span><span class="palette-item-name">Spread Check</span></div>
                      <div class="palette-item" data-node-type="momentum" draggable="true"><span class="palette-item-icon" style="color:#60a5fa">&#10132;</span><span class="palette-item-name">Momentum</span></div>
                      <div class="palette-item" data-node-type="volatility" draggable="true"><span class="palette-item-icon" style="color:#60a5fa">&#10534;</span><span class="palette-item-name">Volatility</span></div>
                      <div class="palette-item" data-node-type="logic-gate" draggable="true"><span class="palette-item-icon" style="color:#60a5fa">&#9783;</span><span class="palette-item-name">Logic Gate</span></div>
                      <div class="palette-item" data-node-type="price-range" draggable="true"><span class="palette-item-icon" style="color:#60a5fa">&#9644;</span><span class="palette-item-name">Price Range</span></div>
                      <div class="palette-item" data-node-type="volume-filter" draggable="true"><span class="palette-item-icon" style="color:#60a5fa">&#9638;</span><span class="palette-item-name">Volume Filter</span></div>
                    </div>
                  </div>
                  <div class="palette-group" data-category="execution">
                    <div class="palette-group-header">
                      <span class="palette-group-indicator">&#9656;</span>
                      <span class="palette-group-dot" style="background:#e8e8e8"></span>
                      <span class="palette-group-name">Execution</span>
                    </div>
                    <div class="palette-group-items">
                      <div class="palette-item" data-node-type="market-order" draggable="true"><span class="palette-item-icon" style="color:#e8e8e8">&#9654;</span><span class="palette-item-name">Market Order</span></div>
                      <div class="palette-item" data-node-type="limit-order" draggable="true"><span class="palette-item-icon" style="color:#e8e8e8">&#9644;</span><span class="palette-item-name">Limit Order</span></div>
                      <div class="palette-item" data-node-type="scaled-entry" draggable="true"><span class="palette-item-icon" style="color:#e8e8e8">&#9638;</span><span class="palette-item-name">Scaled Entry</span></div>
                      <div class="palette-item" data-node-type="dca" draggable="true"><span class="palette-item-icon" style="color:#e8e8e8">&#8635;</span><span class="palette-item-name">DCA</span></div>
                      <div class="palette-item" data-node-type="close-position" draggable="true"><span class="palette-item-icon" style="color:#e8e8e8">&#10006;</span><span class="palette-item-name">Close Position</span></div>
                      <div class="palette-item" data-node-type="hedge" draggable="true"><span class="palette-item-icon" style="color:#e8e8e8">&#9878;</span><span class="palette-item-name">Hedge</span></div>
                      <div class="palette-item" data-node-type="twap" draggable="true"><span class="palette-item-icon" style="color:#e8e8e8">&#9472;</span><span class="palette-item-name">TWAP</span></div>
                      <div class="palette-item" data-node-type="conditional-order" draggable="true"><span class="palette-item-icon" style="color:#e8e8e8">&#9655;</span><span class="palette-item-name">Conditional Order</span></div>
                      <div class="palette-item" data-node-type="rebalance" draggable="true"><span class="palette-item-icon" style="color:#e8e8e8">&#9881;</span><span class="palette-item-name">Rebalance</span></div>
                    </div>
                  </div>
                  <div class="palette-group" data-category="risk">
                    <div class="palette-group-header">
                      <span class="palette-group-indicator">&#9656;</span>
                      <span class="palette-group-dot" style="background:#ff1744"></span>
                      <span class="palette-group-name">Risk</span>
                    </div>
                    <div class="palette-group-items">
                      <div class="palette-item" data-node-type="stop-loss" draggable="true"><span class="palette-item-icon" style="color:#ff1744">&#9888;</span><span class="palette-item-name">Stop Loss</span></div>
                      <div class="palette-item" data-node-type="take-profit" draggable="true"><span class="palette-item-icon" style="color:#ff1744">&#9650;</span><span class="palette-item-name">Take Profit</span></div>
                      <div class="palette-item" data-node-type="trailing-stop" draggable="true"><span class="palette-item-icon" style="color:#ff1744">&#10549;</span><span class="palette-item-name">Trailing Stop</span></div>
                      <div class="palette-item" data-node-type="position-limit" draggable="true"><span class="palette-item-icon" style="color:#ff1744">&#9633;</span><span class="palette-item-name">Position Limit</span></div>
                      <div class="palette-item" data-node-type="portfolio-cap" draggable="true"><span class="palette-item-icon" style="color:#ff1744">&#9651;</span><span class="palette-item-name">Portfolio Cap</span></div>
                      <div class="palette-item" data-node-type="max-drawdown" draggable="true"><span class="palette-item-icon" style="color:#ff1744">&#9660;</span><span class="palette-item-name">Max Drawdown</span></div>
                      <div class="palette-item" data-node-type="time-exit" draggable="true"><span class="palette-item-icon" style="color:#ff1744">&#9203;</span><span class="palette-item-name">Time Exit</span></div>
                      <div class="palette-item" data-node-type="daily-loss-limit" draggable="true"><span class="palette-item-icon" style="color:#ff1744">&#9940;</span><span class="palette-item-name">Daily Loss Limit</span></div>
                      <div class="palette-item" data-node-type="cooldown" draggable="true"><span class="palette-item-icon" style="color:#ff1744">&#10226;</span><span class="palette-item-name">Cooldown</span></div>
                      <div class="palette-item" data-node-type="size-scaler" draggable="true"><span class="palette-item-icon" style="color:#ff1744">&#9878;</span><span class="palette-item-name">Size Scaler</span></div>
                    </div>
                  </div>
                  <div class="palette-group" data-category="utility">
                    <div class="palette-group-header">
                      <span class="palette-group-indicator">&#9656;</span>
                      <span class="palette-group-dot" style="background:#fbbf24"></span>
                      <span class="palette-group-name">Utility</span>
                    </div>
                    <div class="palette-group-items">
                      <div class="palette-item" data-node-type="alert" draggable="true"><span class="palette-item-icon" style="color:#fbbf24">&#9888;</span><span class="palette-item-name">Alert</span></div>
                      <div class="palette-item" data-node-type="delay" draggable="true"><span class="palette-item-icon" style="color:#fbbf24">&#9201;</span><span class="palette-item-name">Delay</span></div>
                      <div class="palette-item" data-node-type="note" draggable="true"><span class="palette-item-icon" style="color:#fbbf24">&#9998;</span><span class="palette-item-name">Note</span></div>
                      <div class="palette-item" data-node-type="splitter" draggable="true"><span class="palette-item-icon" style="color:#fbbf24">&#9698;</span><span class="palette-item-name">Splitter</span></div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Node Inspector (floating overlay) -->
              <div class="node-inspector" id="nodeInspector" style="display:none">
                <div class="inspector-header">
                  <span class="inspector-title" id="inspectorTitle">Properties</span>
                  <button class="inspector-close" id="inspectorClose">&times;</button>
                </div>
                <div class="inspector-body" id="inspectorBody"></div>
                <div class="inspector-footer">
                  <button class="inspector-btn" id="btnDuplicateNode">Duplicate</button>
                  <button class="inspector-btn inspector-btn-danger" id="btnDeleteNode">Delete</button>
                </div>
              </div>
            </div>

            <!-- MercuryScript Mirror -->
            <div class="mercuryscript-panel" id="mercuryScriptPanel">
              <div class="mercuryscript-header">
                <div class="mercuryscript-header-left">
                  <span class="mercuryscript-dot"></span>
                  <span class="mercuryscript-title">MercuryScript</span>
                  <span class="mercuryscript-version" id="scriptVersion">v0.1</span>
                </div>
                <button class="mercuryscript-toggle" id="btnScriptToggle" title="Toggle script panel">
                  <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"></polyline>
                  </svg>
                </button>
              </div>
              <div class="mercuryscript-body" id="mercuryScriptBody">
                <pre class="mercuryscript-code" id="mercuryScriptCode"><span class="ms-comment"># No nodes yet — add nodes or ask Mercury to build a strategy</span></pre>
              </div>
            </div>
          </div>
        </div>

        <!-- Right: Mercury Agent Panel -->
        <div class="agent-panel" id="agentPanel">
          <div class="agent-panel-header">
            <div class="agent-tabs">
              <button class="agent-tab active" data-tab="agent" id="tabAgent">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <circle cx="12" cy="12" r="3"/><ellipse cx="12" cy="12" rx="10" ry="4" transform="rotate(30 12 12)"/>
                </svg>
                Agent
              </button>
            </div>
          </div>

          <!-- Status Bar -->
          <div class="agent-status-bar" id="agentStatusBar">
            <div class="agent-status-badge" id="statusEngine">
              <span class="status-dot disconnected"></span>
              <span>Engine Offline</span>
            </div>
            <div class="agent-status-badge" id="statusBots">
              <span class="status-dot live"></span>
              <span>0 Bots Live</span>
            </div>
            <div class="agent-status-badge" id="statusPoly">
              <span class="status-dot disconnected"></span>
              <span>Polymarket</span>
            </div>
            <div class="agent-status-badge" id="statusKalshi">
              <span class="status-dot disconnected"></span>
              <span>Kalshi</span>
            </div>
          </div>

          <!-- Agent Tab Content -->
          <div class="agent-tab-content active" id="agentTabContent">
            <div class="agent-messages" id="agentMessages">
              <!-- Welcome message -->
              <div class="agent-welcome">
                <div class="agent-welcome-icon">
                  <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <circle cx="12" cy="12" r="3"/><ellipse cx="12" cy="12" rx="10" ry="4" transform="rotate(30 12 12)"/><ellipse cx="12" cy="12" rx="10" ry="4" transform="rotate(-30 12 12)"/>
                  </svg>
                </div>
                <div class="agent-welcome-title">Mercury Agent</div>
                <div class="agent-welcome-text">Describe any strategy and Mercury assembles the building blocks — triggers, logic, execution, and risk management — then deploys to production infrastructure.</div>
              </div>
            </div>
            <div class="agent-input-area">
              <div class="agent-quick-prompts" id="agentQuickPrompts">
                <button class="agent-quick-btn" onclick="useQuickPrompt('Find mispriced elections contracts on Polymarket')">Find election edge</button>
                <button class="agent-quick-btn" onclick="useQuickPrompt('Scan for arbitrage opportunities across markets')">Scan for arbitrage</button>
                <button class="agent-quick-btn" onclick="useQuickPrompt('Build a momentum strategy for crypto prediction markets')">Momentum strategy</button>
                <button class="agent-quick-btn" onclick="useQuickPrompt('What markets have unusual volume right now?')">Unusual volume</button>
              </div>
              <div class="agent-input-row">
                <input class="agent-input" id="agentInput" placeholder="Ask Mercury to find edge..." spellcheck="false">
                <button class="agent-send" id="agentSend">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                  </svg>
                </button>
              </div>
            </div>
          </div>

        </div>
      </div>
    </section>

    <!-- ──────────────────────────────────────────────────────
         VIEW 2: MY BOTS
    ────────────────────────────────────────────────────── -->
    <section id="view-my-bots" class="app-view">
      <div class="view-header">
        <div class="view-header-left">
          <h1 class="view-title">My Bots</h1>
          <span class="view-count" id="botCount">0 bots</span>
        </div>
        <div class="view-header-right">
          <div class="filter-tabs" id="botFilters">
            <button class="filter-tab active" data-filter="all">All</button>
            <button class="filter-tab" data-filter="live">Live</button>
            <button class="filter-tab" data-filter="paused">Paused</button>
            <button class="filter-tab" data-filter="draft">Draft</button>
          </div>
          <select class="sort-select" id="botSort">
            <option value="updated">Last Updated</option>
            <option value="pnl">P&L</option>
            <option value="winrate">Win Rate</option>
            <option value="name">Name</option>
          </select>
          <button class="toolbar-btn toolbar-btn-primary" id="btnNewBot">+ New Bot</button>
        </div>
      </div>
      <div class="bots-grid" id="botsGrid">
        <!-- Bot cards rendered by JS -->
      </div>
    </section>

    <!-- ──────────────────────────────────────────────────────
         VIEW 3: BOT DETAIL
    ────────────────────────────────────────────────────── -->
    <section id="view-bot-detail" class="app-view">
      <div class="detail-header">
        <button class="detail-back" id="detailBack">&larr; Back to My Bots</button>
        <div class="detail-title-row">
          <h1 class="detail-bot-name" id="detailBotName">--</h1>
          <span class="status-badge" id="detailStatus">--</span>
        </div>
        <div class="detail-controls" id="detailControls">
          <button class="toolbar-btn" id="btnPauseBot">Pause</button>
          <button class="toolbar-btn" id="btnRestartBot">Restart</button>
          <button class="toolbar-btn toolbar-btn-danger" id="btnKillBot">Kill</button>
          <button class="toolbar-btn toolbar-btn-danger" id="btnDeleteBot" style="margin-left:8px">Delete</button>
          <button class="toolbar-btn" id="btnEditStrategy">Edit Strategy</button>
        </div>
      </div>

      <div class="detail-scroll">
        <!-- Metrics Row -->
        <div class="detail-metrics" id="detailMetrics"></div>

        <!-- Performance Chart -->
        <div class="detail-chart-card">
          <div class="card-header">
            <span class="card-title">Performance</span>
            <div class="timeframe-tabs" id="detailTimeframe">
              <button class="tf-btn active" data-tf="7d">7D</button>
              <button class="tf-btn" data-tf="30d">30D</button>
              <button class="tf-btn" data-tf="all">All</button>
            </div>
          </div>
          <div class="card-body">
            <div id="detailPerfChart" style="width:100%;height:260px;"></div>
          </div>
        </div>

        <!-- Two-column grid -->
        <div class="detail-lower-grid">
          <!-- Open Positions -->
          <div class="detail-card">
            <div class="card-header">
              <span class="card-title">Open Positions</span>
              <span class="card-meta" id="positionCount">0</span>
            </div>
            <div class="card-body">
              <div class="data-table-header positions-header">
                <span>Contract</span>
                <span>Side</span>
                <span>Qty</span>
                <span>Entry</span>
                <span>P&L</span>
              </div>
              <div id="positionsBody"></div>
            </div>
          </div>

          <!-- Trade History -->
          <div class="detail-card">
            <div class="card-header">
              <span class="card-title">Trade History</span>
              <span class="card-meta" id="tradeCount">0 trades</span>
              <button class="toolbar-btn toolbar-btn-sm" id="btnExportTrades" title="Export trades as CSV" style="margin-left:auto;font-size:11px;padding:2px 8px;">Export CSV</button>
            </div>
            <div class="card-body">
              <div class="data-table-header trades-header">
                <span>Time</span>
                <span>Side</span>
                <span>Contract</span>
                <span>Price</span>
                <span>Amount</span>
                <span>P&L</span>
              </div>
              <div id="tradesBody"></div>
            </div>
          </div>
        </div>

        <!-- Bot Logs -->
        <div class="detail-card detail-card-full">
          <div class="card-header">
            <span class="card-title">Bot Logs</span>
            <span class="card-meta" id="logStatus">
              <span style="color:var(--green)">&#9679;</span> Live
            </span>
            <button class="toolbar-btn toolbar-btn-sm" id="btnExportLogs" title="Export logs as CSV" style="margin-left:auto;font-size:11px;padding:2px 8px;">Export CSV</button>
          </div>
          <div class="card-body">
            <div class="bot-logs" id="botLogs"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- ──────────────────────────────────────────────────────
         VIEW 4: BACKTEST
    ────────────────────────────────────────────────────── -->
    <section id="view-backtest" class="app-view">
      <div class="view-header">
        <div class="view-header-left">
          <h1 class="view-title">Backtest</h1>
        </div>
      </div>

      <div class="bt-layout">
        <!-- LEFT: Strategy + Config -->
        <div class="bt-left-panel">
          <div class="bt-section">
            <label class="field-label">Strategy</label>
            <select class="field-select" id="btStrategyPicker">
              <option value="current">Current Canvas</option>
              <option value="upload">Upload .mercury.json...</option>
            </select>
            <input type="file" id="btFileUpload" accept=".json,.mercury.json" style="display:none" />
            <div class="bt-strategy-info" id="btStrategyInfo"></div>
          </div>

          <div class="bt-section">
            <label class="field-label">Period</label>
            <select class="field-select" id="btPeriod">
              <option value="7">7 Days</option>
              <option value="30">30 Days</option>
              <option value="60">60 Days</option>
              <option value="90" selected>90 Days</option>
              <option value="180">6 Months</option>
              <option value="365">1 Year</option>
            </select>
          </div>

          <div class="bt-section">
            <label class="field-label">Initial Capital</label>
            <input class="field-input" type="number" id="btCapital" value="10000" min="100">
          </div>

          <div class="bt-section">
            <label class="field-label">Interval</label>
            <select class="field-select" id="btInterval">
              <option value="auto" selected>Auto</option>
              <option value="5m">5 min</option>
              <option value="15m">15 min</option>
              <option value="1h">1 hour</option>
              <option value="4h">4 hour</option>
              <option value="1d">1 day</option>
            </select>
          </div>

          <div class="bt-section" style="margin-top:12px;">
            <button class="toolbar-btn toolbar-btn-primary" id="btnRunBacktest" style="width:100%;justify-content:center;">Run Backtest</button>
            <button class="toolbar-btn" id="btCompareToggle" style="width:100%;justify-content:center;margin-top:4px;font-size:11px;opacity:0.7;">⇄ Compare Platforms</button>
          </div>

          <div id="btAutoDetect" style="display:none;margin:6px 0;"></div>

          <div class="bt-selected-market" id="btSelectedMarket"></div>
          <input type="hidden" id="btAsset" value="" />
          <input type="hidden" id="btAssetMeta" value="{}" />

          <div id="btComparePanelB" style="display:none;margin-top:6px;">
            <div style="font-size:10px;color:#555;text-align:center;padding:4px 0;letter-spacing:0.08em;">VS</div>
            <div class="bt-selected-market" id="btSelectedMarketB"></div>
            <input type="hidden" id="btAssetB" value="" />
            <input type="hidden" id="btAssetMetaB" value="{}" />
          </div>
        </div>

        <!-- RIGHT: Market Browser -->
        <div class="bt-market-browser">
          <div id="btSlotSelector" style="display:none;margin-bottom:6px;display:none;">
            <button class="bt-slot-btn active" id="btSlotA" onclick="_setBtSlot('a')">Selecting: Market A</button>
            <button class="bt-slot-btn" id="btSlotB" onclick="_setBtSlot('b')">Selecting: Market B</button>
          </div>
          <input type="text" class="field-input bt-market-search" id="btMarketSearch" placeholder="Search markets..." autocomplete="off" />
          <div class="bt-filter-tabs" id="btMarketFilters">
            <button class="bt-filter-tab active" data-filter="all">All</button>
            <button class="bt-filter-tab" data-filter="kalshi">Kalshi</button>
            <button class="bt-filter-tab" data-filter="polymarket">Polymarket</button>
            <button class="bt-filter-tab" data-filter="crypto">Crypto</button>
            <button class="bt-filter-tab" data-filter="stocks">Stocks</button>
            <button class="bt-filter-tab" data-filter="weather">Weather</button>
          </div>
          <div class="bt-market-list" id="btMarketList">
            <div class="bt-market-loading">Loading markets...</div>
          </div>
        </div>
      </div>

      <!-- Results overlay — takes over the full view when a backtest runs -->
      <div class="bt-results-overlay" id="btResultsOverlay" style="display:none">
        <div class="bt-results-header">
          <button class="toolbar-btn" id="btnBackToSetup" onclick="showBacktestSetup()">Back to Setup</button>
        </div>
        <div class="backtest-running" id="backtestRunning" style="display:none">
          <div class="backtest-spinner"></div>
          <span>Running backtest simulation...</span>
        </div>
        <div class="bt-results-scroll">
          <div id="backtestResults"></div>
        </div>
      </div>
    </section>

    <!-- ──────────────────────────────────────────────────────
         VIEW 5: TEMPLATES
    ────────────────────────────────────────────────────── -->
    <section id="view-templates" class="app-view">
      <div class="view-header">
        <div class="view-header-left">
          <h1 class="view-title">Strategy Templates</h1>
        </div>
        <div class="view-header-right">
          <div class="filter-tabs" id="templateFilters">
            <button class="filter-tab active" data-filter="all">All</button>
            <button class="filter-tab" data-filter="momentum">Momentum</button>
            <button class="filter-tab" data-filter="mean-reversion">Mean Rev</button>
            <button class="filter-tab" data-filter="bond-arb">Bond Arb</button>
            <button class="filter-tab" data-filter="dca">DCA</button>
            <button class="filter-tab" data-filter="event-driven">Event</button>
          </div>
        </div>
      </div>
      <div class="templates-grid" id="templatesGrid">
        <!-- Template cards rendered by JS -->
      </div>
    </section>

    <!-- ──────────────────────────────────────────────────────
         VIEW 6: MERCURY CHARTING + TERMINAL
    ────────────────────────────────────────────────────── -->
    <section id="view-charting" class="app-view tv-layout">

      <!-- Coming Soon Lock Overlay -->
      <div class="charting-lock-overlay" id="chartingLockOverlay">
        <div class="charting-lock-card">
          <div class="charting-lock-icon">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
              <path d="M7 11V7a5 5 0 0110 0v4"/>
            </svg>
          </div>
          <h2 class="charting-lock-title">Live Charting Coming Soon</h2>
          <p class="charting-lock-desc">Real-time candlestick charts with live Polymarket &amp; Kalshi price action, instant execution, and advanced order routing.</p>
          <div class="charting-lock-features">
            <span class="charting-lock-feat">Live OHLC candles</span>
            <span class="charting-lock-feat">Instant execution</span>
            <span class="charting-lock-feat">Cross-platform split orders</span>
            <span class="charting-lock-feat">Iceberg orders</span>
            <span class="charting-lock-feat">Order book depth</span>
            <span class="charting-lock-feat">Volume profiling</span>
          </div>
          <form class="charting-lock-form" id="chartingWaitlistForm">
            <input type="email" class="charting-lock-input" id="chartingWaitlistEmail" placeholder="Enter your email for early access" required />
            <button type="submit" class="charting-lock-btn">Join Waitlist</button>
          </form>
          <p class="charting-lock-note" id="chartingWaitlistMsg"></p>
        </div>
      </div>

      <!-- Charting Tutorial Overlay (keep as-is) -->
      <div class="charting-tutorial-overlay" id="chartingTutorial">
        <div class="charting-tutorial">
          <button class="charting-tutorial-close" id="chartingTutorialClose">&times;</button>
          <div class="charting-tutorial-hero">
            <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color:var(--green)">
              <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
              <line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/>
            </svg>
            <h2>Mercury Charting</h2>
            <p>Real-time prediction market charting &mdash; Polymarket + Kalshi, cross-platform analytics.</p>
          </div>
          <div class="charting-tutorial-actions">
            <button class="charting-tutorial-start" onclick="dismissChartingTutorial();">Get Started</button>
          </div>
        </div>
      </div>

      <!-- ═══ TOP BAR ═══ -->
      <div class="tv-topbar" id="chartingTopbar">
        <div class="tv-topbar-left">
          <span class="tv-logo">Mercury</span>
          <span class="charting-live-dot"></span>
          <span class="charting-live-label">LIVE</span>
        </div>
        <div class="tv-topbar-center">
          <div class="ticker-tape" id="tickerTape">
            <div class="ticker-tape-track" id="tickerTrack"></div>
          </div>
        </div>
        <div class="tv-topbar-right">
          <span class="tv-market-count" id="metricActiveMarkets">0</span>
          <span class="tv-market-count-label">markets</span>
          <span class="charting-clock" id="chartingClock">00:00:00 UTC</span>
        </div>
      </div>

      <!-- ═══ MAIN CONTENT: Chart + Watchlist ═══ -->
      <div class="tv-main">

        <!-- LEFT: Chart Panel -->
        <div class="tv-chart-panel">

          <!-- Chart Header: selected symbol info -->
          <div class="tv-symbol-bar" id="tvSymbolBar">
            <div class="tv-symbol-left">
              <span class="tv-symbol-ticker" id="tvSymbolTicker">---</span>
              <span class="tv-symbol-name" id="tvSymbolName">Select a market</span>
              <span class="tv-symbol-source" id="tvSymbolSource"></span>
            </div>
            <div class="tv-symbol-right">
              <span class="tv-symbol-price" id="tvSymbolPrice">--</span>
              <span class="tv-symbol-change" id="tvSymbolChange"></span>
            </div>
          </div>

          <!-- Chart Toolbar: timeframe + chart type -->
          <div class="tv-chart-toolbar">
            <div class="tv-chart-toolbar-left">
              <div class="tv-tf-group" id="tvChartTfToggle">
                <button class="tv-tf-btn" data-tf="1m">1m</button>
                <button class="tv-tf-btn active" data-tf="5m">5m</button>
                <button class="tv-tf-btn" data-tf="15m">15m</button>
                <button class="tv-tf-btn" data-tf="30m">30m</button>
                <button class="tv-tf-btn" data-tf="1h">1H</button>
              </div>
              <div class="tv-sep"></div>
              <div class="tv-ct-group" id="tvChartTypeToggle">
                <button class="tv-ct-btn active" data-ct="candlestick" title="Candlestick">
                  <svg width="14" height="14" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><line x1="4" y1="2" x2="4" y2="14"/><rect x="2" y="5" width="4" height="5" rx="0.5"/><line x1="12" y1="3" x2="12" y2="13"/><rect x="10" y="6" width="4" height="4" rx="0.5"/></svg>
                </button>
                <button class="tv-ct-btn" data-ct="area" title="Area chart">
                  <svg width="14" height="14" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><polyline points="1,12 4,7 8,9 12,4 15,6"/></svg>
                </button>
              </div>
              <div class="tv-sep"></div>
              <div class="tv-plat-group" id="tvPlatTabs">
                <button class="tv-plat-btn tv-plat-btn--poly active" data-mdplat="polymarket">Poly</button>
                <button class="tv-plat-btn tv-plat-btn--kalshi" data-mdplat="kalshi">Kalshi</button>
              </div>
            </div>
            <div class="tv-chart-toolbar-right">
              <span class="tv-data-label" id="tvDataLabel"></span>
            </div>
          </div>

          <!-- Main Chart -->
          <div class="tv-chart-area">
            <div id="tvMainChart" class="tv-main-chart">
              <div class="tv-chart-placeholder"><div style="display:inline-block;width:20px;height:20px;border:2px solid #222;border-top-color:#00c853;border-radius:50%;animation:spin .8s linear infinite;margin-bottom:10px"></div><br>Loading markets&hellip;</div>
              <style>@keyframes spin{to{transform:rotate(360deg)}}</style>
            </div>
            <div id="tvVolChart" class="tv-vol-chart"></div>
          </div>

          <!-- Stats Bar -->
          <div class="tv-stats-bar" id="tvStatsBar">
            <div class="tv-stat">
              <span class="tv-stat-label">Polymarket</span>
              <span class="tv-stat-value" id="tvStatPoly">--</span>
            </div>
            <div class="tv-stat">
              <span class="tv-stat-label">Kalshi</span>
              <span class="tv-stat-value" id="tvStatKalshi">--</span>
            </div>
            <div class="tv-stat">
              <span class="tv-stat-label">Spread</span>
              <span class="tv-stat-value tv-stat-value--green" id="tvStatSpread">--</span>
            </div>
            <div class="tv-stat">
              <span class="tv-stat-label">24h Vol</span>
              <span class="tv-stat-value" id="tvStatVol">--</span>
            </div>
            <div class="tv-stat">
              <span class="tv-stat-label">Implied Prob</span>
              <span class="tv-stat-value" id="tvStatImplied">--</span>
            </div>
            <div class="tv-stat">
              <span class="tv-stat-label">EV</span>
              <span class="tv-stat-value" id="tvStatEV">--</span>
            </div>
            <div class="tv-stat">
              <span class="tv-stat-label">Resolves</span>
              <span class="tv-stat-value" id="tvStatResolves">--</span>
            </div>
          </div>

          <!-- Bottom Panel: single tabbed area — pick one to show -->
          <div class="tv-bottom-panel">
            <div class="tv-bottom-tabs">
              <button class="tv-bottom-tab active" data-bpanel="news">News</button>
              <button class="tv-bottom-tab" data-bpanel="trending">Trending</button>
              <button class="tv-bottom-tab" data-bpanel="arb">Cross-Platform Arb</button>
            </div>
            <div class="tv-bottom-content">
              <!-- News -->
              <div class="tv-bottom-pane active" id="tvBpNews">
                <div class="news-feed" id="newsFeed"></div>
              </div>
              <!-- Trending Keywords -->
              <div class="tv-bottom-pane" id="tvBpTrending">
                <div class="trending-bar">
                  <div class="trending-bar-left">
                    <span class="trending-bar-label">KEYWORD SPIKES</span>
                    <span class="trending-bar-count" id="trendingCount">--</span>
                  </div>
                  <div class="trending-bar-right">
                    <select class="tv-wl-select" id="trendingCatSelect">
                      <option value="all">All Categories</option>
                      <option value="crypto">Crypto</option>
                      <option value="politics">Politics</option>
                      <option value="econ">Economy</option>
                      <option value="ai">AI/Tech</option>
                      <option value="geopolitics">Geopolitics</option>
                      <option value="sports">Sports</option>
                    </select>
                  </div>
                </div>
                <div class="trending-grid" id="trendingGrid">
                  <div class="trending-loading">Scanning headlines&hellip;</div>
                </div>
              </div>
              <!-- Cross-Platform Arb -->
              <div class="tv-bottom-pane" id="tvBpArb">
                <div class="arb-table-header">
                  <span class="arb-col arb-col--market">Market</span>
                  <span class="arb-col arb-col--poly">Polymarket</span>
                  <span class="arb-col arb-col--kalshi">Kalshi</span>
                  <span class="arb-col arb-col--spread">Spread</span>
                  <span class="arb-col arb-col--action">Cause</span>
                </div>
                <div id="arbTableBody"></div>
              </div>
            </div>
          </div>

        </div>

        <!-- RIGHT: Watchlist Sidebar -->
        <div class="tv-watchlist" id="tvWatchlist">

          <!-- Search -->
          <div class="tv-wl-search">
            <svg class="tv-wl-search-icon" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="7"/><line x1="16.5" y1="16.5" x2="21" y2="21"/></svg>
            <input type="text" class="tv-wl-search-input" id="edgeSearchInput" placeholder="Search markets..." spellcheck="false" autocomplete="off">
          </div>

          <!-- Filters Row -->
          <div class="tv-wl-filters">
            <div class="tv-wl-filter-group" id="edgePlatformTabs">
              <button class="tv-wl-fbtn active" data-plat="all">All</button>
              <button class="tv-wl-fbtn tv-wl-fbtn--poly" data-plat="polymarket">Poly</button>
              <button class="tv-wl-fbtn tv-wl-fbtn--kalshi" data-plat="kalshi">Kalshi</button>
            </div>
            <select class="tv-wl-select" id="edgeSortSelect">
              <option value="chart-quality">Best Charts</option>
              <option value="volume">Volume</option>
              <option value="spread">Spread</option>
              <option value="resolves">Resolves Soon</option>
              <option value="price-high">Price &darr;</option>
              <option value="price-low">Price &uarr;</option>
            </select>
          </div>

          <!-- Category -->
          <div class="tv-wl-filters">
            <select class="tv-wl-select tv-wl-select--full" id="edgeCategorySelect">
              <option value="all">All Categories</option>
              <option value="crypto">Crypto</option>
              <option value="politics">Politics</option>
              <option value="economics">Economics</option>
              <option value="sports">Sports</option>
              <option value="entertainment">Entertainment</option>
              <option value="science">Science &amp; Tech</option>
              <option value="world">World Events</option>
            </select>
            <span class="tv-wl-count" id="edgeFilterMeta"></span>
          </div>

          <!-- Market List -->
          <div class="tv-wl-list" id="edgeChartingCards"></div>

        </div>

      </div>

      <!-- Hidden containers for tabs that still need their elements (Terminal) -->
      <div class="charting-tab-panel" id="rtab-terminal" style="display:none;">
        <div class="charting-grid charting-grid--terminal">
          <div class="charting-module" id="mod-orderbook">
            <div class="module-header">
              <span class="module-title">Order Book</span>
              <div class="module-controls">
                <select class="module-select" id="orderbookMarket">
                  <option>Fed Rate Cut Mar 2026</option>
                  <option>BTC > $100K</option>
                </select>
                <span class="module-live-badge">Live</span>
              </div>
            </div>
            <div class="module-body" id="orderbookBody"></div>
          </div>
          <div class="charting-module" id="mod-volume">
            <div class="module-header">
              <span class="module-title">Volume Footprint</span>
              <div class="module-controls">
                <div class="module-timeframe-tabs" id="volumeTimeframe">
                  <button class="tf-btn active" data-tf="1h">1H</button>
                  <button class="tf-btn" data-tf="4h">4H</button>
                  <button class="tf-btn" data-tf="1d">1D</button>
                </div>
              </div>
            </div>
            <div class="module-body">
              <div id="volumeChart" style="width:100%;height:100%;"></div>
            </div>
          </div>
          <div class="charting-module" id="mod-botlogs">
            <div class="module-header">
              <span class="module-title">Bot Log</span>
              <span class="module-live-badge">LIVE</span>
            </div>
            <div class="module-body">
              <div class="charting-logs" id="chartingLogs"></div>
            </div>
          </div>
          <div class="charting-module" id="mod-chat">
            <div class="module-header">
              <span class="module-title">Charting Chat</span>
            </div>
            <div class="module-body module-body-chat">
              <div class="charting-chat-messages" id="chartingChatMessages">
                <div class="charting-chat-welcome">Ask Mercury anything about markets.</div>
              </div>
              <div class="charting-chat-input-area">
                <input class="charting-chat-input" id="chartingChatInput" placeholder="Ask about markets..." spellcheck="false">
                <button class="charting-chat-send" id="chartingChatSend">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

    </section>

    <!-- ═══ VIEW: PORTFOLIO ═══ -->
    <section id="view-portfolio" class="app-view">
      <div class="view-header">
        <div class="view-header-left">
          <h1 class="view-title">Portfolio</h1>
          <span class="view-count" id="portfolioPositionCount">0 positions</span>
        </div>
        <div class="view-header-right">
          <div class="filter-tabs" id="portfolioFilterTabs">
            <button class="filter-tab active" data-filter="all">All</button>
            <button class="filter-tab" data-filter="open">Open</button>
            <button class="filter-tab" data-filter="settled">Settled</button>
          </div>
          <select class="sort-select" id="portfolioSort">
            <option value="pnl">Sort: P&amp;L</option>
            <option value="value">Sort: Value</option>
            <option value="recent">Sort: Recent</option>
          </select>
        </div>
      </div>

      <!-- Portfolio Equity Chart -->
      <div id="portfolioEquityChart" style="height:180px;margin-bottom:16px;"></div>

      <!-- Portfolio Summary -->
      <div class="portfolio-summary">
        <div class="portfolio-summary-metric portfolio-summary-metric--large">
          <span class="portfolio-summary-label">Portfolio Value</span>
          <span class="portfolio-summary-value" id="portfolioTotalValue">$0.00</span>
        </div>
        <div class="portfolio-summary-metric">
          <span class="portfolio-summary-label">Total P&amp;L</span>
          <span class="portfolio-summary-value portfolio-summary-value--green" id="portfolioTotalPnl">$0.00</span>
        </div>
        <div class="portfolio-summary-metric">
          <span class="portfolio-summary-label">Open Positions</span>
          <span class="portfolio-summary-value" id="portfolioOpenCount">0</span>
        </div>
        <div class="portfolio-summary-metric">
          <span class="portfolio-summary-label">Win Rate</span>
          <span class="portfolio-summary-value" id="portfolioWinRate">--</span>
        </div>
        <div class="portfolio-summary-metric">
          <span class="portfolio-summary-label">Total Trades</span>
          <span class="portfolio-summary-value" id="portfolioSettledCount">0</span>
        </div>
        <div class="portfolio-summary-metric">
          <span class="portfolio-summary-label">Avg Return</span>
          <span class="portfolio-summary-value portfolio-summary-value--green" id="portfolioAvgReturn">--</span>
        </div>
      </div>

      <!-- Positions Table -->
      <div class="portfolio-table">
        <div class="portfolio-table-header">
          <span class="portfolio-col portfolio-col--market">Market</span>
          <span class="portfolio-col portfolio-col--bot">Bot</span>
          <span class="portfolio-col portfolio-col--platform">Platform</span>
          <span class="portfolio-col portfolio-col--side">Side</span>
          <span class="portfolio-col portfolio-col--qty">Qty</span>
          <span class="portfolio-col portfolio-col--avg">Avg Price</span>
          <span class="portfolio-col portfolio-col--current">Current</span>
          <span class="portfolio-col portfolio-col--value">Value</span>
          <span class="portfolio-col portfolio-col--pnl">P&amp;L</span>
        </div>
        <div class="portfolio-table-body" id="portfolioTableBody">
          <div class="bonding-loading">No positions yet&hellip;</div>
        </div>
      </div>

      <!-- Recent Trades -->
      <h3 style="margin:24px 0 8px;font-size:0.7rem;color:var(--silver);font-weight:600;text-transform:uppercase;letter-spacing:0.06em;">Recent Trades</h3>
      <div class="portfolio-table">
        <div class="portfolio-table-header">
          <span class="portfolio-col portfolio-col--time">Time</span>
          <span class="portfolio-col portfolio-col--bot">Bot</span>
          <span class="portfolio-col portfolio-col--side">Side</span>
          <span class="portfolio-col portfolio-col--market">Contract</span>
          <span class="portfolio-col portfolio-col--qty">Qty</span>
          <span class="portfolio-col portfolio-col--avg">Price</span>
          <span class="portfolio-col portfolio-col--value">Amount</span>
          <span class="portfolio-col portfolio-col--pnl">P&amp;L</span>
        </div>
        <div class="portfolio-table-body" id="portfolioTradesBody">
          <div class="bonding-loading">No trades yet&hellip;</div>
        </div>
      </div>
    </section>

    <!-- ═══ VIEW: BONDING ARBITRAGE ═══ -->
    <section id="view-bonding-arb" class="app-view">
      <div class="view-header">
        <div class="view-header-left">
          <h1 class="view-title">One Click Bonds</h1>
          <span class="view-count" id="bondingViewCount">0 opportunities</span>
        </div>
        <div class="view-header-right">
          <div class="filter-tabs" id="bondingViewPlatformTabs">
            <button class="filter-tab active" data-plat="all">All</button>
            <button class="filter-tab" data-plat="polymarket">Poly</button>
            <button class="filter-tab" data-plat="kalshi">Kalshi</button>
          </div>
          <select class="sort-select" id="bondingViewSort">
            <option value="best">Sort: Best</option>
            <option value="yield">Sort: Yield</option>
            <option value="prob">Sort: Prob</option>
            <option value="liq">Sort: Liquidity</option>
            <option value="days">Sort: Soonest</option>
          </select>
        </div>
      </div>

      <!-- Welcome / Explainer (shown until dismissed) -->
      <div class="bond-welcome" id="bondWelcome">
        <button class="bond-welcome-close" onclick="dismissBondWelcome()" title="Dismiss">&times;</button>
        <div class="bond-welcome-header">
          <svg class="bond-welcome-icon" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
          <div>
            <h2 class="bond-welcome-title">Prediction Market Bonds</h2>
            <p class="bond-welcome-subtitle">Low-risk yield from near-certain outcomes</p>
          </div>
        </div>
        <div class="bond-welcome-body">
          <div class="bond-welcome-step">
            <span class="bond-welcome-num">1</span>
            <div>
              <strong>Find near-resolved markets</strong>
              <p>Mercury scans Polymarket and Kalshi for contracts trading above 90c that resolve soon. These are like short-term bonds &mdash; buy at 95c, collect $1 at resolution.</p>
            </div>
          </div>
          <div class="bond-welcome-step">
            <span class="bond-welcome-num">2</span>
            <div>
              <strong>Understand the yield</strong>
              <p>A contract at 97c with 10 days left gives ~3% raw return, or ~113% annualized. The closer to $1 and the sooner it resolves, the safer the bond.</p>
            </div>
          </div>
          <div class="bond-welcome-step">
            <span class="bond-welcome-num">3</span>
            <div>
              <strong>Buy with one click</strong>
              <p>Connect your Polymarket wallet or Kalshi API key using the <strong>Connected Accounts</strong> panel in the sidebar, then click any Buy button to place an order instantly.</p>
            </div>
          </div>
        </div>
        <div class="bond-welcome-footer">
          <button class="toolbar-btn toolbar-btn-primary" onclick="dismissBondWelcome()">Got it, show me the markets</button>
        </div>
      </div>

      <!-- Metrics Row -->
      <div class="bonding-view-metrics">
        <div class="bonding-view-metric">
          <span class="bonding-view-metric-label">Opportunities</span>
          <span class="bonding-view-metric-value" id="bondingViewOpps">0</span>
        </div>
        <div class="bonding-view-metric">
          <span class="bonding-view-metric-label">Avg Return</span>
          <span class="bonding-view-metric-value bonding-view-metric-value--green" id="bondingViewYield">--</span>
        </div>
        <div class="bonding-view-metric">
          <span class="bonding-view-metric-label">Total Liquidity</span>
          <span class="bonding-view-metric-value" id="bondingViewLiq">--</span>
        </div>
        <div class="bonding-view-metric">
          <span class="bonding-view-metric-label">Avg Days to Resolution</span>
          <span class="bonding-view-metric-value" id="bondingViewDays">--</span>
        </div>
      </div>
      <div style="font-size:11px; color:rgba(255,255,255,0.35); text-align:center; margin:-6px 0 8px;">Yields are hypothetical based on current prices. Markets may not resolve as expected.</div>

      <!-- Table -->
      <div class="bonding-view-table">
        <div class="bonding-view-table-header">
          <span class="bonding-vcol bonding-vcol--market">Market</span>
          <span class="bonding-vcol bonding-vcol--platform">Platform</span>
          <span class="bonding-vcol bonding-vcol--side">Side</span>
          <span class="bonding-vcol bonding-vcol--price">Price</span>
          <span class="bonding-vcol bonding-vcol--prob">Prob</span>
          <span class="bonding-vcol bonding-vcol--yield">Return</span>
          <span class="bonding-vcol bonding-vcol--days">Resolves</span>
          <span class="bonding-vcol bonding-vcol--vol">Liquidity</span>
          <span class="bonding-vcol bonding-vcol--action"></span>
        </div>
        <div class="bonding-view-table-body" id="bondingViewBody">
          <div class="bonding-loading">Scanning markets&hellip;</div>
        </div>
      </div>
    </section>

    <!-- ════════ CATALYST VIEW ════════ -->
    <section id="view-catalyst" class="app-view catalyst-layout">

      <!-- Top Bar -->
      <div class="catalyst-topbar">
        <div class="catalyst-topbar-left">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color:var(--green)">
            <path d="M2 12h4l3-9 4 18 3-9h6"/>
          </svg>
          <span class="catalyst-title">CATALYST</span>
          <span class="catalyst-live-dot"></span>
          <span class="catalyst-live-label">LIVE</span>
        </div>
        <div class="catalyst-topbar-right">
          <span class="catalyst-topbar-stat">
            <span class="catalyst-topbar-stat-label">KEYWORDS</span>
            <span class="catalyst-topbar-stat-val" id="catalystKeywordCount">--</span>
          </span>
          <span class="catalyst-topbar-stat">
            <span class="catalyst-topbar-stat-label">HEADLINES</span>
            <span class="catalyst-topbar-stat-val" id="catalystHeadlineCount">--</span>
          </span>
          <span class="catalyst-topbar-stat">
            <span class="catalyst-topbar-stat-label">UPDATED</span>
            <span class="catalyst-topbar-stat-val" id="catalystLastUpdate">--</span>
          </span>
          <span class="catalyst-topbar-stat">
            <span class="catalyst-topbar-stat-label">SOURCE</span>
            <span class="catalyst-topbar-stat-val catalyst-source-val">Google News RSS</span>
          </span>
        </div>
      </div>

      <!-- Controls Bar -->
      <div class="catalyst-controls">
        <div class="catalyst-controls-left">
          <div class="catalyst-cat-tabs" id="catalystCatTabs">
            <button class="catalyst-cat-btn active" data-cat="all">All</button>
            <button class="catalyst-cat-btn" data-cat="crypto">Crypto</button>
            <button class="catalyst-cat-btn" data-cat="politics">Politics</button>
            <button class="catalyst-cat-btn" data-cat="econ">Economy</button>
            <button class="catalyst-cat-btn" data-cat="ai">AI/Tech</button>
            <button class="catalyst-cat-btn" data-cat="geopolitics">Geopolitics</button>
            <button class="catalyst-cat-btn" data-cat="sports">Sports</button>
          </div>
        </div>
        <div class="catalyst-controls-right">
          <select class="catalyst-select" id="catalystSortSelect">
            <option value="count">Frequency</option>
            <option value="change">Recent Change</option>
            <option value="spike">Spike %</option>
            <option value="alpha">A-Z</option>
          </select>
        </div>
      </div>

      <!-- Main Content -->
      <div class="catalyst-main">
        <!-- Left: Keyword Table -->
        <div class="catalyst-table-panel">
          <div class="catalyst-table-header">
            <span class="catalyst-col catalyst-col--kw">Keyword</span>
            <span class="catalyst-col catalyst-col--bar">Frequency</span>
            <span class="catalyst-col catalyst-col--count">Mentions</span>
            <span class="catalyst-col catalyst-col--change">Change</span>
            <span class="catalyst-col catalyst-col--trend">Trend</span>
            <span class="catalyst-col catalyst-col--spike">Spike</span>
            <span class="catalyst-col catalyst-col--cat">Category</span>
          </div>
          <div class="catalyst-table-body" id="catalystTableBody">
            <div class="catalyst-empty">Scanning news headlines&hellip;</div>
          </div>
        </div>

        <!-- Right: Spike Alerts + Category Breakdown -->
        <div class="catalyst-sidebar">
          <!-- Spike Alerts -->
          <div class="catalyst-panel">
            <div class="catalyst-panel-header">
              <span class="catalyst-panel-title">SPIKE ALERTS</span>
              <span class="catalyst-panel-badge" id="catalystSpikeCount">0</span>
            </div>
            <div class="catalyst-panel-body" id="catalystSpikeList">
              <div class="catalyst-empty-sm">No spikes detected yet</div>
            </div>
          </div>

          <!-- Category Breakdown -->
          <div class="catalyst-panel">
            <div class="catalyst-panel-header">
              <span class="catalyst-panel-title">CATEGORY MIX</span>
            </div>
            <div class="catalyst-panel-body" id="catalystCategoryBreakdown">
              <div class="catalyst-empty-sm">Waiting for data&hellip;</div>
            </div>
          </div>
        </div>
      </div>

    </section>

    <!-- ═══════════════════════════════════════════════════════ -->
    <!-- FUNDING VIEW                                            -->
    <!-- ═══════════════════════════════════════════════════════ -->
    <section id="view-funding" class="app-view">
      <div class="view-header">
        <div class="view-header-left">
          <h2 class="view-title">Funding</h2>
          <span class="view-subtitle">Manage wallets, deposits, and withdrawals</span>
        </div>
      </div>

      <div class="funding-layout">
        <!-- Wallet Cards Row -->
        <div class="funding-wallets">

          <!-- Polymarket Wallet -->
          <div class="funding-card" id="fundingPolyCard">
            <div class="funding-card-header">
              <div class="funding-card-icon funding-card-icon--poly">P</div>
              <div>
                <div class="funding-card-title">Polymarket</div>
                <div class="funding-card-network">Polygon USDC.e</div>
              </div>
              <div class="funding-card-status" id="polyWalletStatus">
                <span class="account-dot disconnected"></span>
                <span id="polyStatusText">Not Connected</span>
              </div>
            </div>
            <div class="funding-card-body">
              <div class="funding-balance-row">
                <span class="funding-balance-label">CLOB Balance</span>
                <span class="funding-balance-value" id="polyBalance">--</span>
              </div>
              <div class="funding-balance-row">
                <span class="funding-balance-label">Wallet USDC</span>
                <span class="funding-balance-value" id="polyWalletBalance">--</span>
              </div>
              <div class="funding-balance-row funding-balance-total">
                <span class="funding-balance-label">Total</span>
                <span class="funding-balance-value" id="polyTotalBalance">--</span>
              </div>
              <div class="funding-address-row" id="polyAddressRow" style="display:none;">
                <span class="funding-address-label">Deposit Address</span>
                <div class="funding-address-copy">
                  <code class="funding-address" id="polyAddress">0x...</code>
                  <button class="funding-copy-btn" onclick="copyPolyAddress()">Copy</button>
                </div>
                <div class="funding-address-note">Send USDC on Polygon only</div>
              </div>
            </div>
            <div class="funding-card-actions">
              <button class="funding-btn funding-btn--primary" id="polyConnectBtn" onclick="initPolymarketWallet()">
                Connect Wallet
              </button>
              <button class="funding-btn funding-btn--outline" id="polyRefreshBtn" onclick="refreshPolyBalance()" style="display:none;">
                Refresh
              </button>
              <button class="funding-btn funding-btn--outline" id="polyWithdrawBtn" onclick="openPolyWithdraw()" style="display:none;">
                Withdraw
              </button>
            </div>
          </div>

          <!-- Kalshi Account -->
          <div class="funding-card" id="fundingKalshiCard">
            <div class="funding-card-header">
              <div class="funding-card-icon funding-card-icon--kalshi">K</div>
              <div>
                <div class="funding-card-title">Kalshi</div>
                <div class="funding-card-network">US Regulated</div>
              </div>
              <div class="funding-card-status" id="kalshiWalletStatus">
                <span class="account-dot disconnected"></span>
                <span id="kalshiStatusText">Not Connected</span>
              </div>
            </div>
            <div class="funding-card-body">
              <div class="funding-balance-row">
                <span class="funding-balance-label">Available</span>
                <span class="funding-balance-value" id="kalshiBalance">--</span>
              </div>
              <div class="funding-balance-row">
                <span class="funding-balance-label">P&L</span>
                <span class="funding-balance-value" id="kalshiPnl">--</span>
              </div>
            </div>
            <div class="funding-card-actions">
              <button class="funding-btn funding-btn--primary" id="kalshiConnectBtn" onclick="initKalshiAccount()">
                Connect Account
              </button>
              <button class="funding-btn funding-btn--outline" id="kalshiRefreshBtn" onclick="refreshKalshiBalance()" style="display:none;">
                Refresh
              </button>
            </div>
          </div>
        </div>

        <!-- Positions Section -->
        <div class="funding-section" id="fundingPositionsSection" style="display:none;">
          <div class="funding-section-header">
            <h3>Open Positions</h3>
            <button class="funding-btn funding-btn--sm" onclick="refreshPositions()">Refresh</button>
          </div>
          <div class="funding-table-wrap">
            <table class="funding-table">
              <thead>
                <tr>
                  <th>Market</th>
                  <th>Platform</th>
                  <th>Side</th>
                  <th>Size</th>
                  <th>Price</th>
                  <th>Value</th>
                </tr>
              </thead>
              <tbody id="fundingPositionsBody">
                <tr><td colspan="6" class="funding-empty">Connect a wallet to view positions</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Recent Trades Section -->
        <div class="funding-section" id="fundingTradesSection" style="display:none;">
          <div class="funding-section-header">
            <h3>Recent Trades</h3>
          </div>
          <div class="funding-table-wrap">
            <table class="funding-table">
              <thead>
                <tr>
                  <th>Time</th>
                  <th>Side</th>
                  <th>Price</th>
                  <th>Size</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="fundingTradesBody">
                <tr><td colspan="5" class="funding-empty">No trades yet</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Withdraw Modal (inline) -->
        <div class="funding-modal-overlay" id="polyWithdrawModal" style="display:none;">
          <div class="funding-modal">
            <div class="funding-modal-header">
              <h3>Withdraw USDC</h3>
              <button class="modal-close" onclick="closePolyWithdraw()">&times;</button>
            </div>
            <div class="funding-modal-body">
              <label class="funding-label">Destination Address (Polygon)</label>
              <input type="text" class="funding-input" id="withdrawAddress" placeholder="0x..." />
              <label class="funding-label">Amount (USDC)</label>
              <input type="number" class="funding-input" id="withdrawAmount" placeholder="0.00" min="0" step="0.01" />
              <div class="funding-modal-note" id="withdrawAvailable">Available: --</div>
            </div>
            <div class="funding-modal-footer">
              <button class="funding-btn funding-btn--outline" onclick="closePolyWithdraw()">Cancel</button>
              <button class="funding-btn funding-btn--primary" onclick="submitPolyWithdraw()">Withdraw</button>
            </div>
          </div>
        </div>

      </div>
    </section>

  </main>

  <!-- Kill Switch Confirmation Modal -->
  <div class="modal-overlay" id="killConfirmModal">
    <div class="modal">
      <div class="modal-header">
        <span class="modal-title">Emergency Stop</span>
        <button class="modal-close" onclick="document.getElementById('killConfirmModal').classList.remove('active')">&times;</button>
      </div>
      <div class="modal-body kill-confirm-body">
        <div class="kill-confirm-warning">EMERGENCY STOP</div>
        <div class="kill-confirm-text">This will immediately halt all active bots.</div>
        <div class="kill-confirm-count" id="killBotCount">3 bots</div>
        <div class="kill-confirm-text">This action cannot be undone. Bots must be manually restarted.</div>
      </div>
      <div class="modal-footer">
        <button class="toolbar-btn" id="killCancelBtn">Cancel</button>
        <button class="toolbar-btn" id="killConfirmBtn" style="background:var(--red);color:var(--pure);border-color:var(--red);">KILL ALL BOTS</button>
      </div>
    </div>
  </div>

  <!-- Deploy Modal -->
  <div class="modal-overlay" id="deployModal">
    <div class="modal">
      <div class="modal-header">
        <span class="modal-title">Deploy Strategy</span>
        <button class="modal-close" id="deployModalClose">&times;</button>
      </div>
      <div class="modal-body">
        <div class="inspector-field">
          <label class="field-label">Bot Name</label>
          <input class="field-input" id="deployBotName" value="">
        </div>
        <div class="inspector-field">
          <label class="field-label">Platform</label>
          <select class="field-select" id="deployPlatform">
            <option value="Polymarket">Polymarket</option>
            <option value="Kalshi">Kalshi</option>
            <option value="Auto">Auto</option>
          </select>
        </div>
        <div class="inspector-field">
          <label class="field-label">Capital Allocation ($)</label>
          <input class="field-input" type="number" id="deployCapital" value="1000" min="10">
        </div>
        <div class="inspector-field">
          <label class="field-label">Mode</label>
          <select class="field-select" id="deployMode">
            <option value="paper">Paper Trading</option>
            <option value="live">Live Trading</option>
          </select>
        </div>
        <!-- Exchange status (shown when live selected) -->
        <div id="deployExchangeStatus" class="deploy-exchange-status" style="display:none">
          <div class="deploy-exchange-row">
            <span class="account-dot disconnected" id="deployPolyDot"></span>
            <span>Polymarket</span>
            <span class="deploy-exchange-label" id="deployPolyLabel">No Wallet</span>
          </div>
          <div class="deploy-exchange-row">
            <span class="account-dot disconnected" id="deployKalshiDot"></span>
            <span>Kalshi</span>
            <span class="deploy-exchange-label" id="deployKalshiLabel">Not Configured</span>
          </div>
        </div>
        <!-- Live warning -->
        <div id="deployLiveWarning" class="deploy-live-warning" style="display:none">
          This bot will execute real trades with real money. Ensure your wallet is funded before deploying.
        </div>
        <!-- Funding hint -->
        <div class="fund-deploy-hint">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="rgba(255,215,0,0.7)" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
          <span>Build a 60-day live track record with Sharpe &gt; 1.25 to <a href="/funding.html" style="color:rgba(255,215,0,0.85);">apply for up to $5,000 in funding</a></span>
        </div>
      </div>
      <div class="modal-footer">
        <button class="toolbar-btn" id="deployCancel">Cancel</button>
        <button class="toolbar-btn toolbar-btn-primary" id="deployConfirm">Deploy Bot</button>
      </div>
    </div>
  </div>

  <!-- Live Trading Review Modal -->
  <div class="modal-overlay" id="liveReviewModal">
    <div class="modal" style="max-width:600px;">
      <div class="modal-header">
        <span class="modal-title" style="color:var(--red,#ff4444);">⚠ Live Trading Review</span>
        <button class="modal-close" id="liveReviewClose">&times;</button>
      </div>
      <div class="modal-body" style="max-height:70vh;overflow-y:auto;">
        <!-- Strategy Summary -->
        <div style="background:rgba(255,68,68,0.08);border:1px solid rgba(255,68,68,0.25);border-radius:8px;padding:14px;margin-bottom:16px;">
          <div style="font-weight:600;margin-bottom:8px;color:rgba(255,255,255,0.95);">Strategy Summary</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px 16px;font-size:13px;">
            <span style="color:rgba(255,255,255,0.5);">Bot Name</span><span id="lrBotName" style="color:rgba(255,255,255,0.9);"></span>
            <span style="color:rgba(255,255,255,0.5);">Platform</span><span id="lrPlatform" style="color:rgba(255,255,255,0.9);"></span>
            <span style="color:rgba(255,255,255,0.5);">Capital</span><span id="lrCapital" style="color:rgba(255,215,0,0.9);font-weight:600;"></span>
            <span style="color:rgba(255,255,255,0.5);">Mode</span><span style="color:var(--red,#ff4444);font-weight:700;">LIVE TRADING</span>
          </div>
        </div>

        <!-- Live Risk Configuration -->
        <div class="lr-config-section">
          <div class="lr-config-title">Your Live Trading Settings</div>
          <div class="lr-config-subtitle">Adjust these to control how much real money each trade uses. Template defaults are for paper trading — set your own limits for live.</div>
          <div class="lr-config-grid">
            <div class="lr-config-field">
              <label class="lr-config-label">Trade Size ($)</label>
              <input type="number" class="lr-config-input" id="lrTradeSize" value="25" min="1" max="10000" step="5">
              <div class="lr-config-hint">Amount per order execution</div>
            </div>
            <div class="lr-config-field">
              <label class="lr-config-label">Max Positions</label>
              <input type="number" class="lr-config-input" id="lrMaxPositions" value="3" min="1" max="50" step="1">
              <div class="lr-config-hint">Maximum concurrent open positions</div>
            </div>
            <div class="lr-config-field">
              <label class="lr-config-label">Stop Loss (%)</label>
              <input type="number" class="lr-config-input" id="lrStopLoss" value="10" min="1" max="50" step="1">
              <div class="lr-config-hint">Max loss before closing position</div>
            </div>
            <div class="lr-config-field">
              <label class="lr-config-label">Daily Loss Limit ($)</label>
              <input type="number" class="lr-config-input" id="lrDailyLimit" value="100" min="5" max="10000" step="5">
              <div class="lr-config-hint">Stop trading after this daily loss</div>
            </div>
          </div>
          <div class="lr-config-note">These settings override template defaults for all execution and risk nodes in your strategy.</div>
        </div>

        <!-- Risk Controls -->
        <div style="margin-bottom:16px;">
          <div style="font-weight:600;margin-bottom:8px;color:rgba(255,255,255,0.95);font-size:14px;">Risk Controls</div>
          <div id="lrRiskParams" style="font-size:13px;"></div>
        </div>

        <!-- Execution Rules -->
        <div style="margin-bottom:16px;">
          <div style="font-weight:600;margin-bottom:8px;color:rgba(255,255,255,0.95);font-size:14px;">Execution Rules</div>
          <div id="lrExecParams" style="font-size:13px;"></div>
        </div>

        <!-- Triggers -->
        <div style="margin-bottom:16px;">
          <div style="font-weight:600;margin-bottom:8px;color:rgba(255,255,255,0.95);font-size:14px;">Triggers</div>
          <div id="lrTriggerParams" style="font-size:13px;"></div>
        </div>

        <!-- Terms (hidden after first acceptance) -->
        <div id="lrTermsSection">
          <div style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:14px;margin-bottom:16px;max-height:200px;overflow-y:auto;font-size:12px;color:rgba(255,255,255,0.55);line-height:1.6;">
            <div style="font-weight:600;margin-bottom:8px;color:rgba(255,255,255,0.8);font-size:13px;">Live Trading Terms & Conditions</div>
            <p>By deploying this bot in live trading mode, you acknowledge and agree to the following:</p>
            <p><strong>1. Risk of Loss.</strong> Automated trading involves substantial risk of financial loss. You may lose some or all of your invested capital. Past performance of any strategy, whether in paper trading or backtesting, does not guarantee future results.</p>
            <p><strong>2. No Guarantee of Performance.</strong> Mercury provides the platform and tools for building and executing trading strategies. Mercury does not guarantee the accuracy, reliability, or profitability of any strategy. All strategies are user-configured and user-deployed.</p>
            <p><strong>3. User Responsibility.</strong> You are solely responsible for reviewing, understanding, and approving all strategy parameters — including triggers, execution rules, risk controls, and capital allocation — before deploying in live mode. You confirm that the parameters displayed above are correct and reflect your intended trading behavior.</p>
            <p><strong>4. No Liability.</strong> Mercury, its creators, affiliates, and contributors shall not be held liable for any direct, indirect, incidental, consequential, or special damages arising from the use of this platform, including but not limited to financial losses from live trading, execution errors, system downtime, API failures, or market conditions.</p>
            <p><strong>5. No Financial Advice.</strong> Nothing on this platform constitutes financial, investment, or trading advice. Mercury is a tool for executing user-defined strategies. You should consult a qualified financial advisor before making investment decisions.</p>
            <p><strong>6. Exchange Risk.</strong> Live trades are executed on third-party exchanges (Polymarket, Kalshi, etc.). Mercury is not responsible for exchange outages, settlement failures, regulatory actions, or changes to exchange terms that may affect your positions.</p>
            <p><strong>7. Data Accuracy.</strong> Market data used by triggers and indicators is sourced from third-party APIs. Mercury does not guarantee the accuracy, timeliness, or completeness of this data. Delays or inaccuracies in data may result in unintended trades.</p>
            <p><strong>8. Irrevocable Execution.</strong> Once deployed, live trades are submitted to exchanges and may not be reversible. While you can stop the bot at any time, open positions and pending orders may need to be manually managed.</p>
            <p><strong>9. Acceptance.</strong> By checking the box below and clicking "Confirm & Deploy Live," you confirm that you have read, understood, and agree to these terms, and that you accept full responsibility for any outcomes resulting from this live deployment.</p>
          </div>

          <!-- Checkbox -->
          <label style="display:flex;align-items:flex-start;gap:10px;cursor:pointer;padding:8px 0;">
            <input type="checkbox" id="lrTermsCheckbox" style="margin-top:3px;accent-color:var(--red,#ff4444);min-width:18px;min-height:18px;">
            <span style="font-size:13px;color:rgba(255,255,255,0.85);line-height:1.5;">I have reviewed all strategy parameters above and agree to the <strong>Live Trading Terms & Conditions</strong>. I understand that live trading involves real money and risk of loss.</span>
          </label>
        </div>

        <!-- Shown when terms already accepted -->
        <div id="lrTermsAccepted" style="display:none;padding:8px 12px;background:rgba(0,200,150,0.08);border:1px solid rgba(0,200,150,0.25);border-radius:6px;font-size:13px;color:rgba(255,255,255,0.7);">
          ✓ You have previously accepted the Live Trading Terms. Please review the parameters above before confirming.
        </div>
      </div>
      <div class="modal-footer">
        <button class="toolbar-btn" id="liveReviewCancel">Cancel</button>
        <button class="toolbar-btn" id="liveReviewConfirm" disabled style="background:var(--red,#ff4444);color:var(--pure,#fff);border-color:var(--red,#ff4444);opacity:0.4;cursor:not-allowed;">Confirm & Deploy Live</button>
      </div>
    </div>
  </div>

  <!-- Commit Modal -->
  <div class="modal-overlay" id="commitModal">
    <div class="modal">
      <div class="modal-header">
        <span class="modal-title">Commit Strategy</span>
        <button class="modal-close" id="commitModalClose">&times;</button>
      </div>
      <div class="modal-body">
        <div class="commit-diff" id="commitDiff">
          <div class="commit-diff-line added">+ 4 nodes</div>
          <div class="commit-diff-line added">+ 3 connections</div>
        </div>
        <div class="inspector-field">
          <label class="field-label">Commit Message</label>
          <input class="field-input" id="commitMessage" placeholder="e.g. v1.2 - Adjusted for low liquidity" spellcheck="false">
        </div>
        <div class="commit-history" id="commitHistory">
          <div class="commit-entry">
            <span class="commit-hash">a1b2c3</span>
            <span class="commit-msg">Initial strategy</span>
            <span class="commit-time">just now</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="toolbar-btn" id="commitCancel">Cancel</button>
        <button class="toolbar-btn toolbar-btn-primary" id="commitConfirm">Commit</button>
      </div>
    </div>
  </div>

  <!-- Market Detail Modal (replaced by inline TV chart) -->
  <div class="modal-overlay" id="marketDetailModal" style="display:none;"></div>

  <!-- Mobile Welcome Modal — shown once on first visit from a mobile device -->
  <div class="modal-overlay" id="mobileWelcomeModal">
    <div class="modal mobile-welcome-modal">
      <div class="mobile-welcome-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="40" height="40">
          <rect x="5" y="2" width="14" height="20" rx="2"/>
          <line x1="12" y1="18" x2="12" y2="18.01"/>
        </svg>
      </div>
      <div class="mobile-welcome-title">Best on Desktop</div>
      <div class="mobile-welcome-body">
        Mercury's strategy builder and node editor are designed for desktop. You can still manage bots, run backtests, and chat with the AI agent on mobile — but for building strategies, use a laptop or desktop.
      </div>
      <div class="mobile-welcome-actions">
        <button class="toolbar-btn mobile-welcome-ok" id="mobileWelcomeOk">Got it, continue on mobile</button>
      </div>
    </div>
  </div>

  <!-- Connect Account Modal -->
  <div class="modal-overlay" id="connectAccountModal">
    <div class="modal" style="max-width:500px;">
      <div class="modal-header">
        <span class="modal-title" id="connectModalTitle">Connect Account</span>
        <button class="modal-close" id="connectModalClose">&times;</button>
      </div>
      <div class="modal-body">
        <div class="connect-platform-badge" id="connectPlatformBadge">POLYMARKET</div>

        <!-- Polymarket: Managed wallet via Turnkey secure enclave -->
        <div id="connectWalletSection">
          <div class="connect-method-label">Polymarket Trading Account</div>

          <!-- State: No wallet yet -->
          <div id="walletStateCreate">
            <!-- Trust badges — always visible -->
            <div style="display:flex;gap:6px;margin-bottom:14px;flex-wrap:wrap;">
              <div style="display:flex;align-items:center;gap:4px;padding:4px 9px;background:rgba(74,222,128,0.06);border:1px solid rgba(74,222,128,0.2);border-radius:4px;font-size:10px;">
                <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="#4ade80" stroke-width="2.5"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                <span style="color:#4ade80;">Non-custodial</span>
              </div>
              <div style="display:flex;align-items:center;gap:4px;padding:4px 9px;background:rgba(96,165,250,0.06);border:1px solid rgba(96,165,250,0.2);border-radius:4px;font-size:10px;">
                <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="#60a5fa" stroke-width="2.5"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
                <span style="color:#60a5fa;">Keys in secure enclave</span>
              </div>
              <div style="display:flex;align-items:center;gap:4px;padding:4px 9px;background:rgba(167,139,250,0.06);border:1px solid rgba(167,139,250,0.2);border-radius:4px;font-size:10px;">
                <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="#a78bfa" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
                <span style="color:#a78bfa;">Sequoia-backed</span>
              </div>
            </div>

            <button class="connect-wallet-btn" id="createWalletBtn" onclick="createManagedWallet()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="6" width="20" height="14" rx="0"/><path d="M16 14a2 2 0 100-4 2 2 0 000 4z"/><path d="M2 10h20"/></svg>
              Connect Wallet
            </button>

            <!-- Secured-by strip + expandable details -->
            <div style="margin-top:12px;">
              <div style="display:flex;align-items:center;justify-content:space-between;padding:7px 10px;background:rgba(255,255,255,0.03);border:1px solid var(--border);border-radius:5px;">
                <div style="display:flex;align-items:center;gap:6px;">
                  <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="#4ade80" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                  <span style="font-size:10px;color:var(--dim);">Secured by <a href="https://www.turnkey.com/security-by-turnkey" target="_blank" rel="noopener" style="color:var(--fg);text-decoration:underline;text-underline-offset:2px;">Turnkey</a> secure enclave</span>
                </div>
                <a href="#" onclick="var el=document.getElementById('connectSecurityExplainer');el.style.display=el.style.display==='none'?'block':'none';return false;" style="font-size:10px;color:var(--accent);text-decoration:underline;text-underline-offset:2px;white-space:nowrap;">How it works</a>
              </div>
              <div id="connectSecurityExplainer" style="display:none;margin-top:6px;padding:12px;background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:5px;font-size:11px;line-height:1.6;color:var(--dim);">
                <strong style="color:var(--fg);display:block;margin-bottom:6px;">Non-custodial wallet architecture</strong>
                Your wallet is secured by <strong style="color:var(--fg);">Turnkey</strong>, which uses AWS Nitro secure enclaves (Trusted Execution Environments). Your private keys are generated and stored inside these enclaves — they never exist on Mercury's servers, in any database, or anywhere accessible to us or anyone else.<br><br>
                <strong style="color:var(--fg);">What this means for you:</strong>
                <ul style="margin:6px 0 0 16px;padding:0;">
                  <li>Mercury has <strong style="color:var(--fg);">no ability to access, move, or withdraw your funds</strong> — the keys only respond to authenticated requests tied to your account.</li>
                  <li>Even if Mercury's servers were fully compromised, your funds are safe. The keys live in Turnkey's enclave, not our infrastructure.</li>
                  <li>Every trade signature happens inside the enclave only when your bot triggers it. The key never leaves the chip.</li>
                  <li>Fully on-chain — verify your wallet's activity anytime on <a href="https://polygonscan.com" target="_blank" rel="noopener" style="color:var(--accent);text-decoration:underline;text-underline-offset:2px;">Polygonscan</a>.</li>
                </ul>
                <div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border);font-size:10px;">
                  Turnkey is backed by Sequoia and used by leading crypto platforms. <a href="https://www.turnkey.com/security-by-turnkey" target="_blank" rel="noopener" style="color:var(--accent);text-decoration:underline;text-underline-offset:2px;">Security overview</a> &middot; <a href="https://docs.turnkey.com/security/non-custodial-key-mgmt" target="_blank" rel="noopener" style="color:var(--accent);text-decoration:underline;text-underline-offset:2px;">Technical docs</a>
                </div>
              </div>
            </div>
          </div>

          <!-- State: Wallet exists -->
          <div id="walletStateActive" style="display:none;">
            <div class="wallet-info-card">
              <div class="wallet-info-row">
                <span class="wallet-info-label">Wallet Address (Polygon)</span>
                <div class="wallet-address-row">
                  <code class="wallet-address" id="walletAddress">—</code>
                  <button class="wallet-copy-btn" onclick="copyWalletAddress()" title="Copy address">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="0"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
                  </button>
                </div>
              </div>
              <div class="wallet-info-row">
                <span class="wallet-info-label">Network</span>
                <span class="wallet-info-value">Polygon (MATIC) — USDC only</span>
              </div>
              <div class="wallet-balance-grid">
                <div class="wallet-balance-item">
                  <div class="wallet-balance-label">Available USDC</div>
                  <div class="wallet-balance-value" id="walletBalanceUsdc">$0.00</div>
                </div>
                <div class="wallet-balance-item">
                  <div class="wallet-balance-label">In Positions</div>
                  <div class="wallet-balance-value" id="walletBalancePositions">$0.00</div>
                </div>
                <div class="wallet-balance-item">
                  <div class="wallet-balance-label">Pending</div>
                  <div class="wallet-balance-value" id="walletBalancePending">$0.00</div>
                </div>
              </div>
              <div class="wallet-actions">
                <button class="toolbar-btn toolbar-btn-primary" onclick="openDepositInfo()" style="font-size:10px;">Deposit</button>
                <button class="toolbar-btn" onclick="openWithdrawModal()" style="font-size:10px;">Withdraw</button>
                <button class="toolbar-btn" onclick="viewWalletHistory()" style="font-size:10px;">History</button>
              </div>
            </div>
            <div class="wallet-security-note">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#4ade80" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
              <span>Non-custodial — secured by <a href="https://www.turnkey.com/security-by-turnkey" target="_blank" rel="noopener" style="color:var(--accent);text-decoration:underline;text-underline-offset:2px;">Turnkey</a> secure enclave. Mercury cannot access your keys or funds.
                <a href="#" onclick="document.getElementById('depositSecurityExplainer').style.display = 'block'; openDepositInfo(); return false;" style="color:var(--accent);text-decoration:underline;text-underline-offset:2px;margin-left:4px;">How it works</a>
              </span>
            </div>
          </div>
        </div>

        <!-- API Key connection (Kalshi) -->
        <div id="connectApiSection">
          <div class="connect-method-label" id="connectApiLabel">Kalshi API Credentials</div>
          <div class="connect-field">
            <label class="connect-field-label">API Key</label>
            <input type="text" class="connect-input" id="connectApiKey" placeholder="Paste your Kalshi API key" autocomplete="off" />
          </div>
          <div class="connect-field">
            <label class="connect-field-label">RSA Private Key (PEM)</label>
            <textarea class="connect-input" id="connectPrivateKeyPem" placeholder="-----BEGIN RSA PRIVATE KEY-----&#10;...&#10;-----END RSA PRIVATE KEY-----" autocomplete="off" rows="6" style="font-family:var(--font-mono);font-size:10px;resize:vertical;"></textarea>
          </div>
          <div class="connect-api-note" style="margin-top:8px;">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
            <span>Your private key is encrypted before storage and only used to sign Kalshi API requests. Generate credentials at <a href="https://kalshi.com/account/api" target="_blank" rel="noopener" style="color:var(--accent);">kalshi.com/account/api</a>.</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="toolbar-btn" id="connectCancel">Cancel</button>
        <button class="toolbar-btn toolbar-btn-primary" id="connectConfirm">Connect</button>
      </div>
    </div>
  </div>

  <!-- Deposit Info Modal -->
  <div class="modal-overlay" id="depositInfoModal">
    <div class="modal" style="max-width:440px;">
      <div class="modal-header">
        <span class="modal-title">Deposit USDC.e</span>
        <button class="modal-close" onclick="closeDepositInfo()">&times;</button>
      </div>
      <div class="modal-body" style="padding:16px 20px;">

        <!-- USDC vs USDC.e explainer -->
        <div style="background:rgba(255,200,0,0.06);border:1px solid rgba(255,200,0,0.2);border-radius:6px;padding:10px 12px;margin-bottom:14px;font-size:11.5px;line-height:1.6;">
          <div style="font-weight:600;color:#f5c518;margin-bottom:4px;">⚠ Polymarket requires USDC.e, not USDC</div>
          <div style="color:var(--dim);">Most exchanges (Coinbase, Binance) give you <strong style="color:var(--fg);">native USDC</strong>. Polymarket uses <strong style="color:var(--fg);">USDC.e</strong> — a bridged version on Polygon. They look the same but have different contract addresses. Sending native USDC directly will result in stuck funds.<br><br>
          <strong style="color:var(--fg);">Easiest path:</strong> Send native USDC here, then click <em>Convert</em> below — Mercury will swap it to USDC.e automatically (~1% fee covers the DEX swap).</div>
        </div>

        <div class="deposit-address-section">
          <div class="field-label">Your Wallet Address (Polygon)</div>
          <div class="deposit-address-display">
            <code id="depositAddress">—</code>
            <button class="wallet-copy-btn" onclick="copyWalletAddress()" title="Copy">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="0"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
            </button>
          </div>
        </div>
        <div class="deposit-details">
          <div class="deposit-detail-row">
            <span>Network</span>
            <span>Polygon (Chain ID: 137)</span>
          </div>
          <div class="deposit-detail-row">
            <span>Accepted</span>
            <span>USDC.e <em style="color:var(--dim);font-size:10px;">or native USDC (then convert)</em></span>
          </div>
          <div class="deposit-detail-row">
            <span>Min Deposit</span>
            <span>$5.00</span>
          </div>
        </div>

        <!-- Auto-convert section -->
        <div id="syncUsdcSection" style="margin-top:14px;padding:12px;background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:6px;">
          <div style="font-size:11px;font-weight:600;margin-bottom:8px;color:var(--fg);">Already sent native USDC? Convert it here</div>
          <div id="syncUsdcIdle">
            <button class="deploy-btn" style="width:100%;font-size:12px;padding:8px;" onclick="checkAndConvertUsdc()">Check balance &amp; get conversion quote</button>
          </div>
          <div id="syncUsdcQuote" style="display:none;">
            <div id="syncUsdcQuoteText" style="font-size:11.5px;color:var(--dim);margin-bottom:8px;line-height:1.5;"></div>
            <div style="display:flex;gap:8px;">
              <button class="deploy-btn" style="flex:1;font-size:12px;padding:8px;" onclick="executeUsdcConvert()">Convert now</button>
              <button class="toolbar-btn" style="font-size:12px;padding:8px 12px;" onclick="document.getElementById('syncUsdcQuote').style.display='none';document.getElementById('syncUsdcIdle').style.display='block';">Cancel</button>
            </div>
          </div>
          <div id="syncUsdcPending" style="display:none;text-align:center;font-size:11.5px;color:var(--dim);padding:6px 0;">
            <span id="syncUsdcStatus">Submitting swap...</span>
          </div>
          <div style="margin-top:8px;font-size:10.5px;color:var(--dim);text-align:center;">
            Prefer to swap manually? <a href="https://app.1inch.io/#/137/simple/swap/0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359/0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174" target="_blank" rel="noopener" style="color:var(--accent);text-decoration:underline;text-underline-offset:2px;">Open 1inch</a>
          </div>
        </div>

        <!-- Security explainer -->
        <div style="margin-top:14px;text-align:center;">
          <a href="#" onclick="document.getElementById('depositSecurityExplainer').style.display = document.getElementById('depositSecurityExplainer').style.display === 'none' ? 'block' : 'none'; return false;" style="font-size:11px;color:var(--accent);">
            <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-1px;margin-right:3px;"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>How are my funds protected?
          </a>
        </div>
        <div id="depositSecurityExplainer" style="display:none;margin-top:10px;padding:12px;background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:5px;font-size:11px;line-height:1.6;color:var(--dim);">
          <strong style="color:var(--fg);display:block;margin-bottom:6px;">Non-custodial wallet architecture</strong>
          Your wallet is secured by <strong style="color:var(--fg);">Turnkey</strong>, which uses AWS Nitro secure enclaves (Trusted Execution Environments). Your private keys are generated and stored inside these enclaves — they never exist on Mercury's servers, in any database, or anywhere accessible to us.<br><br>
          <strong style="color:var(--fg);">What this means for you:</strong>
          <ul style="margin:6px 0 0 16px;padding:0;">
            <li>Mercury has <strong style="color:var(--fg);">no ability to access, move, or withdraw your funds</strong> — the keys only respond to authenticated requests tied to your account.</li>
            <li>Even if Mercury's servers were fully compromised, your funds are safe. The keys live in Turnkey's enclave, not our infrastructure.</li>
            <li>Every trade signature happens inside the enclave only when your bot triggers it. The key never leaves the chip.</li>
            <li>Fully on-chain — verify your wallet's activity anytime on <a href="https://polygonscan.com" target="_blank" rel="noopener" style="color:var(--accent);text-decoration:underline;text-underline-offset:2px;">Polygonscan</a>.</li>
          </ul>
          <div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border);font-size:10px;">
            Turnkey is backed by Sequoia and used by leading crypto platforms. <a href="https://www.turnkey.com/security-by-turnkey" target="_blank" rel="noopener" style="color:var(--accent);text-decoration:underline;text-underline-offset:2px;">Security overview</a> &middot; <a href="https://docs.turnkey.com/security/non-custodial-key-mgmt" target="_blank" rel="noopener" style="color:var(--accent);text-decoration:underline;text-underline-offset:2px;">Technical docs</a>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="toolbar-btn" onclick="closeDepositInfo()">Close</button>
      </div>
    </div>
  </div>

  <!-- Withdraw Modal -->
  <div class="modal-overlay" id="withdrawModal">
    <div class="modal" style="max-width:440px;">
      <div class="modal-header">
        <span class="modal-title">Withdraw USDC</span>
        <button class="modal-close" onclick="closeWithdrawModal()">&times;</button>
      </div>
      <div class="modal-body" style="padding:16px 20px;">
        <div class="inspector-field">
          <label class="field-label">Destination Address (Polygon)</label>
          <input class="field-input" id="withdrawAddress" type="text" placeholder="0x..." spellcheck="false" autocomplete="off">
        </div>
        <div class="inspector-field">
          <label class="field-label">Amount (USDC)</label>
          <div style="display:flex;gap:8px;align-items:center;">
            <input class="field-input" id="withdrawAmount" type="number" placeholder="0.00" min="1" step="0.01" style="flex:1;">
            <button class="toolbar-btn" onclick="setMaxWithdraw()" style="font-size:9px;padding:4px 8px;">Max</button>
          </div>
          <div style="font-size:10px;color:var(--dim);margin-top:4px;">
            Available: <span id="withdrawAvailable">$0.00</span>
          </div>
        </div>
        <div id="withdrawCooldownMsg" style="display:none;" class="deposit-warning">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
          <span id="withdrawCooldownText">Withdrawal cooldown active.</span>
        </div>
      </div>
      <div class="modal-footer">
        <button class="toolbar-btn" onclick="closeWithdrawModal()">Cancel</button>
        <button class="toolbar-btn toolbar-btn-primary" id="withdrawConfirmBtn" onclick="confirmWithdraw()">Withdraw</button>
      </div>
    </div>
  </div>

  <!-- Bond Buy Modal -->
  <div class="modal-overlay" id="bondBuyModal">
    <div class="modal" style="max-width:480px;">
      <div class="modal-header">
        <span class="modal-title" id="bondBuyModalTitle">Buy Bond</span>
        <button class="modal-close" onclick="closeBondBuyModal()">&times;</button>
      </div>
      <div class="modal-body" style="padding:16px 20px;">
        <!-- Market Info -->
        <div class="bond-buy-market-info">
          <div class="bond-buy-market-name" id="bondBuyMarketName">--</div>
          <div class="bond-buy-market-meta">
            <span id="bondBuyPlatform">--</span>
            <span id="bondBuySide">--</span>
            <span id="bondBuyDays">--</span>
          </div>
        </div>

        <!-- Price Summary -->
        <div class="bond-buy-price-row">
          <div class="bond-buy-price-item">
            <span class="bond-buy-price-label">Bond Price</span>
            <span class="bond-buy-price-value" id="bondBuyPrice">--</span>
          </div>
          <div class="bond-buy-price-item">
            <span class="bond-buy-price-label">Raw Yield</span>
            <span class="bond-buy-price-value bond-buy-price-value--green" id="bondBuyRawYield">--</span>
          </div>
          <div class="bond-buy-price-item">
            <span class="bond-buy-price-label">Annualized</span>
            <span class="bond-buy-price-value bond-buy-price-value--green" id="bondBuyAnnYield">--</span>
          </div>
        </div>

        <!-- Amount Input -->
        <div class="inspector-field" style="margin-top:12px;">
          <label class="field-label">Amount (USD)</label>
          <div style="display:flex;gap:8px;align-items:center;">
            <input class="field-input" id="bondBuyAmount" type="number" placeholder="10.00" min="1" step="1" style="flex:1;">
            <button class="toolbar-btn" onclick="setBondBuyMax()" style="font-size:9px;padding:4px 8px;">Max</button>
          </div>
          <div style="font-size:10px;color:var(--dim);margin-top:4px;">
            Available: <span id="bondBuyBalance">$0.00</span>
          </div>
        </div>

        <!-- Estimated Output -->
        <div class="bond-buy-estimate" id="bondBuyEstimate" style="display:none;">
          <div class="bond-buy-estimate-row">
            <span>Contracts / Shares</span>
            <span id="bondBuyContracts">--</span>
          </div>
          <div class="bond-buy-estimate-row">
            <span>Cost</span>
            <span id="bondBuyCost">--</span>
          </div>
          <div class="bond-buy-estimate-row">
            <span>Payout at Resolution</span>
            <span id="bondBuyPayout">--</span>
          </div>
          <div class="bond-buy-estimate-row bond-buy-estimate-row--profit">
            <span>Expected Profit</span>
            <span id="bondBuyProfit">--</span>
          </div>
          <div class="bond-buy-estimate-row" style="color:var(--dim);">
            <span>Est. Slippage</span>
            <span id="bondBuySlippage">--</span>
          </div>
        </div>

        <!-- Account Warning -->
        <div class="bond-buy-warning" id="bondBuyWarning" style="display:none;">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
          <span id="bondBuyWarningText">--</span>
        </div>
      </div>
      <div class="modal-footer">
        <button class="toolbar-btn" onclick="closeBondBuyModal()">Cancel</button>
        <button class="toolbar-btn toolbar-btn-primary" id="bondBuyConfirmBtn" onclick="confirmBondBuy()" disabled>Confirm Buy</button>
      </div>
    </div>
  </div>

  <!-- Profile / Account Settings Modal -->
  <div class="modal-overlay" id="profileModal">
    <div class="modal" style="max-width:420px;">
      <div class="modal-header">
        <span class="modal-title">Account Settings</span>
        <button class="modal-close" onclick="closeProfileModal()">&times;</button>
      </div>
      <div class="modal-body" style="padding:16px 20px;">
        <div class="profile-section">
          <div class="profile-section-label">Email</div>
          <div class="profile-section-value" id="profileEmail">—</div>
        </div>
        <div class="profile-section">
          <div class="profile-section-label">Plan</div>
          <div style="display:flex;align-items:center;gap:10px;">
            <span class="profile-section-value" id="profilePlan">Free</span>
          </div>
        </div>
        <div class="profile-section" style="border-bottom:none;">
          <div class="profile-section-label">Change Password</div>
          <div style="display:flex;flex-direction:column;gap:8px;">
            <input class="field-input" type="password" id="profileNewPw" placeholder="New password" style="font-size:11px;">
            <input class="field-input" type="password" id="profileConfirmPw" placeholder="Confirm new password" style="font-size:11px;">
            <button class="toolbar-btn" onclick="changePassword()" style="align-self:flex-start;font-size:10px;">Update Password</button>
            <div id="profilePwMsg" style="font-size:10px;color:var(--dim);display:none;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Compiler Deploy Animation -->
  <div class="compiler-overlay" id="compilerOverlay">
    <div class="compiler-terminal">
      <div class="compiler-header">
        <span class="compiler-title">&gt;_ Deploying</span>
        <div class="compiler-dots">
          <span class="compiler-dot red"></span>
          <span class="compiler-dot yellow"></span>
          <span class="compiler-dot green"></span>
        </div>
      </div>
      <div class="compiler-output" id="compilerOutput"></div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast">
    <span class="toast-message" id="toastMessage"></span>
    <button class="toast-close" id="toastClose">&times;</button>
  </div>

  <!-- Config (must run before all other scripts) -->
  <script>
    (function() {
      var isLocal = window.location.hostname === 'localhost'
        || window.location.hostname === '127.0.0.1'
        || window.location.protocol === 'file:';
      var engineBase = window.MERCURY_ENGINE_BASE || (isLocal
        ? 'http://localhost:8778'
        : window.location.origin + '/engine');
      window.MERCURY_CONFIG = {
        engineBase: engineBase,
        isLocal: isLocal,
      };
    })();
  </script>

  <!-- Scripts (v3 cache-bust) -->
  <script src="./scripts/page-transition.js?v=28"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.45.1/dist/apexcharts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="./scripts/auth.js?v=28"></script>
  <script src="./scripts/tiers.js?v=28"></script>
  <script src="./scripts/upgrade-modal.js?v=28"></script>
  <script src="./scripts/wallet-service.js?v=28"></script>
  <script src="./scripts/tour-engine.js?v=28"></script>
  <script src="./scripts/node-types.js?v=1"></script>
  <script src="./scripts/strategy-templates.js?v=1"></script>
  <script src="./scripts/agent.js?v=1"></script>
  <script src="./scripts/bot-manager.js?v=1"></script>
  <script src="./scripts/backtest.js?v=5"></script>
  <script src="./scripts/architect-app.js?v=66"></script>
  <script src="./scripts/data-bridge.js?v=34"></script>
  <script src="./scripts/charting.js?v=49"></script>
  <script src="./scripts/funding.js?v=3"></script>
  <script src="./scripts/ambient.js?v=28"></script>
</body>
</html>
